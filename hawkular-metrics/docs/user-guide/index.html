<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Metrics Documentation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link href="../../../css/tabzilla.css" rel="stylesheet">
    <link href="../../../css/styles.css" rel="stylesheet">
    <link href="../../../css/prettify.css" rel="stylesheet">
    <link href="../../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../../js/moment.min.js"></script>
    <script src="../../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">
    <div id="wrap">
      <div class="dropup">
        <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
        <script>
            window.addEventListener('load', function() {
                 renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
        </script>
      </div>

    	<!-- Fixed navbar -->
        <nav class="navbar navbar-fixed-top" role="navigation">
          <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button class="navbar-toggle collapsed" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../../../">Home</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav">
                <li><a href="../../../overview/">Overview</a></li>
                <li><a href="../../../blog.html">Blog</a></li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Services<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li class="menu-item dropdown dropdown-submenu">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../hawkular-services/docs/quickstart-guide/">Quickstart</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../hawkular-services/docs/installation-guide/">Installation Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../hawkular-services/docs/user-guide/">User Guide</a>
                        </li>
                        <li class="menu-item dropdown dropdown-submenu">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">REST API</a>
                          <ul class="dropdown-menu">
                            <li class="menu-item ">
                              <a href="../../../docs/rest/rest-alerts.html">Alerting</a>
                            </li>
                            <li class="menu-item ">
                              <a href="../../../docs/rest/rest-inventory.html">Inventory</a>
                            </li>
                            <li class="menu-item ">
                              <a href="../../../docs/rest/rest-metrics.html">Metrics</a>
                            </li>
                          </ul>
                        </li>
                      </ul>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-services/releases">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular APM<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                      <li><a href="../../../hawkular-apm/">Overview</a></li>
                    </li>
                    <li>
                      <a href="https://hawkular.gitbooks.io/hawkular-apm-user-guide/content/">Documentation</a>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-apm/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Metrics<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../hawkular-metrics/docs/user-guide/">User Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../docs/rest/rest-metrics.html">Metrics REST API</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../docs/rest/rest-alerts.html">Alerting REST API</a>
                        </li>
                      </ul>
                  </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-metrics/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li><a href="../../../hawkular-clients/">Hawkular Clients</a></li>
                <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                  Community
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu">
                  <li>
                    <a href="../../../community/docs/getting-involved/">Getting Involved</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../../community/docs/developer-guide/">Developer Guide</a>
                  </li>
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../community/labs/datamining/">Datamining</a>
                        </li>
                        <li class="menu-item ">
                          <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../hawkular-clients/android-client/">Android client</a>
                        </li>
                        <li class="menu-item ">
                          <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                        </li>
                      </ul>
                  </li>
                  <li>
                    <a href="https://github.com/hawkular">GitHub Repositories</a>
                  <li>
                    <a href="https://travis-ci.org/hawkular">CI Builds</a>
                  </li>
                </ul></li>
              </ul>
            </div>
          </div>
        </nav>

      <section class="main-banner">
        <div class="container">
          <h1>Metrics Documentation</h1>
          <p></p>
        </div>
      </section>

	<!--<p><em>15 June 2015</em></p>-->

	<section>
      <div class="container">
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_tenants">Tenants</a>
<ul class="sectlevel2">
<li><a href="#_creating_tenants">Creating Tenants</a></li>
<li><a href="#_tenant_header">Tenant Header</a></li>
<li><a href="#_tenant_ids">Tenant Ids</a></li>
</ul>
</li>
<li><a href="#_metrics">Metrics</a>
<ul class="sectlevel2">
<li><a href="#_metric_types">Metric Types</a></li>
<li><a href="#_rate">Rate</a></li>
<li><a href="#_metric_ids">Metric Ids</a></li>
<li><a href="#_creating_metrics">Creating Metrics</a></li>
</ul>
</li>
<li><a href="#_identifiers">Identifiers</a></li>
<li><a href="#_inserting_data">Inserting Data</a>
<ul class="sectlevel2">
<li><a href="#_data_points">Data Points</a></li>
<li><a href="#_examples">Examples</a></li>
<li><a href="#_failures">Failures</a></li>
</ul>
</li>
<li><a href="#_data_retention_and_removal">Data Retention and Removal</a></li>
<li><a href="#_tagging">Tagging</a>
<ul class="sectlevel2">
<li><a href="#_creating_metric_tags">Creating Metric Tags</a></li>
<li><a href="#_updating_metric_tags">Updating Metric Tags</a></li>
<li><a href="#_deleting_metric_tags">Deleting Metric Tags</a></li>
<li><a href="#_data_point_tags">Data Point Tags</a></li>
<li><a href="#_tag_filtering">Tag Filtering</a></li>
</ul>
</li>
<li><a href="#_querying">Querying</a>
<ul class="sectlevel2">
<li><a href="#_metric_definitions">Metric Definitions</a></li>
<li><a href="#_raw_data">Raw Data</a></li>
<li><a href="#_counter_rates">Counter Rates</a></li>
<li><a href="#_downsampling">Downsampling</a></li>
</ul>
</li>
<li><a href="#_alerting">Alerting</a>
<ul class="sectlevel2">
<li><a href="#_stream_based_alerting">Stream-Based Alerting</a></li>
<li><a href="#_query_based_alerting">Query-Based Alerting</a></li>
</ul>
</li>
<li><a href="#_security">Security</a></li>
<li><a href="#_links">Links</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hawkular Metrics is a scalable, asynchronous, multi tenant, long term metrics storage engine that uses
<a href="http://cassandra.apache.org">Cassandra</a> as the data store and REST as the primary interface. This section
provides an overview of some of the key features of Hawkular Metrics. The following sections provide in-depth
discussions on these as well as other features.</p>
</div>
<div class="paragraph">
<p><strong>Scalability</strong><br>
Hawkular Metrics is all about scalability. You can run a single instance backed by a single Cassandra node. You can
also scale out Cassandra to multiple nodes to handle increasing loads. The Hawkular Metrics server employs a stateless
architecture, which makes it easy to scale out as well.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/metrics_scalability.png" alt="metrics scalability" width="500" height="350">
</div>
</div>
<div class="paragraph">
<p>This diagram illustrates the various deployment options made possible with Hawkular Metrics' scalable architecture. The
upper left shows the simplest deployment with a single Cassandra node and single Hawkular Metrics node.</p>
</div>
<div class="paragraph">
<p>The bottom right picture shows that it is possible to run more Hawkular Metrics nodes than Cassandra nodes. In reality
this scenario may be somewhat unlikely; however, this example. The Cassandra node is running on a machine with long
term persistent storage, but the Hawkular Metrics nodes are running in containers that can come or go at any time.
Running multiple nodes provides fault tolerance.</p>
</div>
<div class="paragraph">
<p>The upper right picture has a single Hawkular Metrics node with multiple Cassandra nodes. As load increases and there
is a need to scale out from the simple deployment in the upper left, this is the next logical step. Because of its
asynchronous, stateless design, a single Hawkular Metrics node can handle large numbers of requests. As the Cassandra
cluster expands that single Hawkular Metrics instance will be able to handle a larger load because it distributes the
requests across Cassandra nodes.</p>
</div>
<div class="paragraph">
<p>The bottom right picture has multiple Cassandra nodes as well as multiple Hawkular Metrics nodes. Multiple Hawkular
Metrics nodes are deployed in order to distribute load and to provide fault tolerance. Note that Hawkular Metrics
itself does not provide load balancing. A separate load balance would have to be put in front of the Hawkular Metrics
nodes.</p>
</div>
<div class="paragraph">
<p><strong>REST</strong><br>
JSON over REST is the primary interface of Hawkular Metrics. This makes it easier for users to get started and also
makes integration easier since REST+JSON is widely used and easily understood.
a rich, growing set of features that includes:</p>
</div>
<div class="paragraph">
<p><strong>Multi Tenancy</strong><br>
Hawkular Metrics provides <em>virtual</em> multi tenancy. All data is mapped to a tenant, but the data on disk is not
physically partitioned by tenant. From an API perspective though, everything is partitioned by tenant. All requests,
both reads and writes, must include a tenant id.</p>
</div>
<div class="paragraph">
<p><strong>Metric Types</strong><br>
Hawkular Metrics supports common metric types including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>gauges</p>
</li>
<li>
<p>counters</p>
</li>
<li>
<p>rates</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Tagging</strong><br>
Hawkular Metrics provides flexible tagging support that makes it easy to organize and group data. Tagging can also be
used to provide additional information and context about data.</p>
</div>
<div class="paragraph">
<p><strong>Querying</strong><br>
Hawkular Metrics offers a rich set of features around querying that are ideal for rendering data in graphs and in
charts. This includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Filtering and grouping with tags</p>
</li>
<li>
<p>Searching metric definitions</p>
</li>
<li>
<p>Downsampling and aggregation</p>
</li>
<li>
<p>Limit and order results</p>
</li>
<li>
<p>Stacking</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Automatic Data Removal</strong><br>
Each metric or time series can be thought of as a continuous stream of data. In systems like this, deleting and purging
data presents some challenges due to the potentially unbounded data growth. Hawkular Metrics makes it much more
manageable by providing automatic data deletion and removal.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tenants">Tenants</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All data is partitioned by tenant. Data is not physically partitioned on disk. The partitioning happens at the API
level. This means that a metric cannot exist on its own outside of a tenant. Let&#8217;s first look at how tenants are
created.</p>
</div>
<div class="sect2">
<h3 id="_creating_tenants">Creating Tenants</h3>
<div class="paragraph">
<p>Tenants are created in one of two ways. First, a tenant can be created implicitly by simply inserting metric data.
Clients can immediately start storing data without first creating a tenant.</p>
</div>
<div class="listingblock">
<div class="title">Implicit tenant creation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/gauges/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a request to insert gauge data points for the <code>com.acme</code> tenant. If that tenant does not already exist, it will
be request when storing the metric data. Specific details on inserting data can be found in <a href="#_inserting_data">Inserting Data</a>.</p>
</div>
<div class="paragraph">
<p>Tenants can also be created explicitly.</p>
</div>
<div class="listingblock">
<div class="title">Explicit tenant creation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/tenants -d '{"id": "com.acme"}'
-H "Content-Type: application/json"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The request body is pretty simple. It only requires an <code>id</code> property.</p>
</div>
<div class="paragraph">
<p>There is an important distinction between the two ways of creating tenants. The <code>/tenants</code> endpoint checks to see if a
tenant with the specified id already exists. If one does, Hawkular Metrics returns an error response with a 409 status
code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tenant_header">Tenant Header</h3>
<div class="paragraph">
<p>As previously stated all data is partitioned by tenant. Hawkular Metrics enforces this by requiring the
<code>Hawkular-Tenant</code> HTTP header in requests. The value of the header is the tenant id. We saw this already with the
implicit tenant creation. The <code>/tenants</code> endpoint is one exception in that it does not require the header.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tenant_ids">Tenant Ids</h3>
<div class="paragraph">
<p>A tenant has an id that uniquely identifies it. The id is a variable length, UTF-8 encoded string. Hawkular Metrics
does not perform any validation checks to prevent duplicate ids. This is in large part due to Cassandra&#8217;s design. Among
other things, Cassandra is a key/value store. Inserting a row into Cassandra is similar to inserting an entry into a
map. If the key already exists in the map, it will simply be overwritten with the new value. This is exactly how
Cassandra behaves.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If a duplicate id is used, data will be silently overwritten. Users are responsible for ensuring that tenant ids are
unique.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_metrics">Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A metric represents a single time series that can be thought of as a continuous stream of data points. We will get into
the details of data points in <a href="#_inserting_data">Inserting Data</a>. For now, it is sufficient to know that a data point consists
of a timestamp and a value.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The terms metric, metric definition, and time series will be interchangeably throughout the documentation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This section discusses metric types, metric ids, and metric creation.</p>
</div>
<div class="sect2">
<h3 id="_metric_types">Metric Types</h3>
<div class="paragraph">
<p>Three types of metrics are currently supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Availability</p>
</li>
<li>
<p>Gauge</p>
</li>
<li>
<p>Counter</p>
</li>
<li>
<p>String</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_availability">Availability</h4>
<div class="paragraph">
<p>Represents the availability of a resource such as host machine (physical or virtual) or an application server. There
are only three supported availability types or values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>up</p>
</li>
<li>
<p>down</p>
</li>
<li>
<p>unknown</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Availability is stored as single, unsigned byte.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gauge">Gauge</h4>
<div class="paragraph">
<p>Has a numeric value that can fluctuate, going up or down. Some examples of gauges include,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Available heap space in the JVM</p>
</li>
<li>
<p>Number of active HTTP sessions on a web server</p>
</li>
<li>
<p>Disk space used by a database</p>
</li>
<li>
<p>Execution time for a REST API call</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With each of these examples, values can increase or decrease. In some instances, like JVM heap space, there are
well-defined bounds for the possible values; however, that is not always the case.</p>
</div>
<div class="paragraph">
<p>A gauge value is stored as a 64-bit floating point number.</p>
</div>
</div>
<div class="sect3">
<h4 id="_counter">Counter</h4>
<div class="paragraph">
<p>Has a numeric value that monotonically increases or decreases. Some examples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Total number of requests to a REST endpoint</p>
</li>
<li>
<p>Total number of request timeouts for a Cassandra node</p>
</li>
<li>
<p>Total number of request timeouts for a Cassandra cluster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These examples involve values that are always increasing. Note however that counter can also be decreasing.</p>
</div>
<div class="paragraph">
<p>A counter value is stored as a 64-bit signed long.</p>
</div>
<div class="paragraph">
<p>There are two types of counters commonly uses with time series databases (TSDBs). One stores the current count or total
with each data point. The other stores the delta or increment with each data point. The former is more commonly used
with counters that can easily be maintained by the client. Tracking the total number of requests to a REST endpoint for
a specific server can be done easily by the client. Tracking the total number of requests for the endpoint across all
servers however is more challenging. This can be done more easily by storing the deltas and allowing the TSDB to
compute and maintain the total count.</p>
</div>
<div class="paragraph">
<p>Hawkular Metrics only supports the former in which each data point represents the total count; however, we can easily
simulate counters that store deltas using gauges.</p>
</div>
</div>
<div class="sect3">
<h4 id="_string">String</h4>
<div class="paragraph">
<p>The String metric type stores any arbitrary strings. Hawkular Metrics already has an Availability metric type, but it is
limited to a predefined number of values which cannot easily be changed. In some cases a String type with arbritrary values
would better fit for availability events. It can also be used for storing and tracking other types of events.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that there is currently a 2 KB limit for string data points. This limitation may be configurable in the future.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rate">Rate</h3>
<div class="paragraph">
<p>A rate is a derived metric whose values are computed from counter or gauge data points. Rate data points can be retrieved for
any counter or gauge. They are represented as 64-bit floating point numbers.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Rate data points are not persisted. They are computed at query time.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_metric_ids">Metric Ids</h3>
<div class="paragraph">
<p>Every metric has an id that uniquely identifies it. The id consists of three parts - the tenant id, the metric type,
and the metric name. The tenant id is a variable length, UTF-8 encoded string. The metric type is stored as a one byte
integer. The metric name is stored as a variable length, UTF-8 encoded string.</p>
</div>
<div class="paragraph">
<p>The parts that comprise the metric id provide namespacing. A metric name only has to be unique for the metric type and
the tenant. For example, suppose we have a tenant id of com.acme. The com.acme tenant could have a gauge named
http_request_time and also have a counter named http_request_time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_metrics">Creating Metrics</h3>
<div class="paragraph">
<p>Just like tenants, metrics can be created implicitly while inserting data points. They can also be created explicitly.
Let&#8217;s first look at the implicit approach.</p>
</div>
<div class="listingblock">
<div class="title">Implicit gauge creation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/gauges/http_request_time/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a request to insert gauge data points for <code>http_request_time</code> under the <code>com.acme</code> tenant. The metric
definition will be created if it does not already exist. The details on inserting data are covered in
<a href="#_inserting_data">Inserting Data</a>.</p>
</div>
<div class="paragraph">
<p>Here are example for implicitly creating counter and availability metrics.</p>
</div>
<div class="listingblock">
<div class="title">Implicit counter creation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/counters/http_requests/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implicit availability creation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/availability/http_server/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at the alternative approach for creating metrics.</p>
</div>
<div class="listingblock">
<div class="title">Explicit gauge creation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/gauges -d '{"id": "http_request_time"}' \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The request body is pretty simple. It only requires an <code>id</code> property. Creating counter and availability metrics is
pretty similar.</p>
</div>
<div class="listingblock">
<div class="title">Explicit counter creation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/counters -d '{"id": "http_requests"}' \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Explicit availability creation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/availability -d '{"id": "http_server"}' \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is an important distinction between the two ways of creating metrics. The <code>/gauges</code>, <code>/counters</code>, and
<code>/availability</code> endpoints check to see if a metric with the specified id already exists. If one does, Hawkular Metrics
returns an error response with a 409 status code.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_identifiers">Identifiers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All identifiers are stored as variable length, UTF-8 encoded strings. This includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tenant ids</p>
</li>
<li>
<p>Metric names (see <a href="#_metric_ids">Metric Ids</a> section below for more details on metric names</p>
</li>
<li>
<p>Tag keys (for both metric and data point tags)</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
At present there is no restriction on characters that can be used in identifiers. This may change in the future
though (See <a href="https://issues.jboss.org/browse/HWKMETRICS-208">HWKMETRICS-208</a> for details). For this reason it is
recommended to restrict the characters to letters, numbers, underscore, period, and forward slash.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If an identifier uses a character that is defined as special character in the HTTP spec, it must be encoded. Forward
slashes are no exception. If for example I have a tenant id of <code>com/acme</code>, then in HTTP requests it should be encoded
as <code>com%2Facme</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_inserting_data">Inserting Data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Inserting data is a synchronous operation with respect to the client. An HTTP response is not returned until all data points
are inserted. On the server side however, multiple inserts to the database are done in parallel to achieve higher
throughput.</p>
</div>
<div class="sect2">
<h3 id="_data_points">Data Points</h3>
<div class="paragraph">
<p>A data point in Hawkular Metrics is a tuple that in its simplest form consists of a timestamp and a value.
The value of a data point will vary depending on the metric type. Timestamps are
<a href="https://en.wikipedia.org/wiki/Unix_time">unix timestamps</a> in milliseconds. All</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples">Examples</h3>
<div class="paragraph">
<p>There are several operations available for inserting data points.</p>
</div>
<div class="sect3">
<h4 id="_gauge_data">Gauge Data</h4>
<div class="listingblock">
<div class="title">Insert data points for a single gauge</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/gauges/request_size/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {"timestamp": 1460413065369, "value": 3.14},
  {"timestamp": 1460413025569, "value": 4.57},
  {"timestamp": 1460111065369, "value": 5.056}
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The gauge name is <code>request_size</code> and the endpoint is <code>/hawkular/metrics/gauges/$metric/raw</code>.
The value of the <code>timestamp</code> property should be a unix timestamp.<br>
<br></p>
</div>
<div class="listingblock">
<div class="title">Insert data points for multiple gauges</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/gauges/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {
    "id": "free_memory",
    "data": [
      {"timestamp": 1460111065369, "value": 2048},
      {"timestamp": 1460151065369, "value": 2012}
    ]
  },
  {
    "id": "used_memory",
    "data": [
      {"timestamp": 1460111065369, "value": 2048},
      {"timestamp": 1460151065369, "value": 2075}
    ]
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The request body is a bit more complex. Each array element is an object that has <code>id</code> and <code>data</code> properties. <code>data</code>
contains an array of data points.</p>
</div>
</div>
<div class="sect3">
<h4 id="_counter_data">Counter Data</h4>
<div class="listingblock">
<div class="title">Insert data points for a single counter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/counters/total_requests/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {"timestamp": 1460413065369, "value": 69},
  {"timestamp": 1460413025569, "value": 65},
  {"timestamp": 1460111065369, "value": 51}
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Insert data points for multiple counters</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/counters/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {
    "id": "page_views",
    "data": [
      {"timestamp": 1460111065369, "value": 238},
      {"timestamp": 1460151065369, "value": 254}
    ]
  },
  {
    "id": "error_count",
    "data": [
      {"timestamp": 1460111065369, "value": 12},
      {"timestamp": 1460151065369, "value": 17}
    ]
  }
]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_availability_data">Availability Data</h4>
<div class="listingblock">
<div class="title">Insert data points for a single availability</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/availability/server1/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {"timestamp": 1460413065369, "value": "down"},
  {"timestamp": 1460413025569, "value": "down"},
  {"timestamp": 1460111065369, "value": "up"}
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Insert data points for multiple availabilities</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/availability/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {
    "id": "server1",
    "data": [
      {"timestamp": 1460111065369, "value": "up"},
      {"timestamp": 1460151065369, "value": "up"}
    ]
  },
  {
    "id": "server2",
    "data": [
      {"timestamp": 1460111065369, "value": "unknown"},
      {"timestamp": 1460151065369, "value": "up"}
    ]
  }
]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mixed_data">Mixed Data</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/metrics/data -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "gauges": [
    {
      "id": "free_memory",
      "data": [
        {"timestamp": 1460111065369, "value": 2048},
        {"timestamp": 1460151065369, "value": 2012}
      ]
    },
    {
      "id": "used_memory",
      "data": [
        {"timestamp": 1460111065369, "value": 2048},
        {"timestamp": 1460151065369, "value": 2075}
      ]
    }
  ],
  "counters": [
    {
      "id": "page_views",
      "data": [
        {"timestamp": 1460111065369, "value": 238},
        {"timestamp": 1460151065369, "value": 254}
      ]
    },
    {
      "id": "error_count",
      "data": [
        {"timestamp": 1460111065369, "value": 12},
        {"timestamp": 1460151065369, "value": 17}
      ]
    }
  ],
  "availability": [
    {
      "id": "server1",
      "data": [
        {"timestamp": 1460111065369, "value": "up"},
        {"timestamp": 1460151065369, "value": "up"}
      ]
    },
    {
      "id": "server2",
      "data": [
        {"timestamp": 1460111065369, "value": "unknown"},
        {"timestamp": 1460151065369, "value": "up"}
      ]
    }
  ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_failures">Failures</h3>
<div class="paragraph">
<p>If there is an error inserting a data point, the operation is aborted and any data in the request not yet written into
the database will be ignored. When there is an error, there is no reliable way to determine the remaining data
points that still need to be persisted. This is due to the fact that writes to the database are asynchronous and are
done in parallel. This means data points will not necessarily be written in the order received.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Unless stated otherwise, it can be assumed that writes in Hawkular Metrics are idempotent as is the case with writing
data points. If there is an error writing data points, the client can simply retry the request.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_retention_and_removal">Data Retention and Removal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Metric data is automatically deleted from the system after an amount of time that is determined by data retention
settings. Data retention can be specified at various levels and is specified in days. There is a system-wide default of
seven days. This setting will apply to all metrics in the system if no other settings are specified. The system-wide
setting can be overridden at start up by either setting the <code>hawkular.metrics.default-ttl</code> system property or by
setting the <code>DEFAULT_TTL</code> environment variable.</p>
</div>
<div class="paragraph">
<p>Data retention can also be set per tenant. To do this, you need to explicitly create the tenant as in the following
example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/tenants -d @request.json \
-H "Content-Type: application/json"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "id": "com.acme",
  "retentions": {
    "gauge": 10,
    "counter": 5,
    "availability": 8
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example uses the curl shell command. The request body is put in a file to improve readability. The <code>retentions</code>
map consists of names of one or more metric types. The value of each is an integer which represents the data retention
for that metric type in days.</p>
</div>
<div class="paragraph">
<p>You can also set data retention at the individual metric level. This would override any tenant data retention as well
as the system-wide default. Here is an example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/metrics -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "id": "request_size",
  "dataRetention": 10
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request creates a gauge named <code>request_size</code> with a data retention of 10 days.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Hawkular Metrics currently lacks APIs for changing data retention. See
<a href="https://issues.jboss.org/browse/HWKMETRICS-380">HWKMETRICS-380</a> for details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>TODO</strong>
Add section on how Cassandra handles deletes. (Actually a separate page with some basic info on Cassandra
administration might be good)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tagging">Tagging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tags in Hawkular Metrics are key/value pairs. Tags can be applied to a metric to provide meta data for the time series
as a whole. Tags can also be applied to individual data points. Tags can be used to perform filtering in queries.</p>
</div>
<div class="sect2">
<h3 id="_creating_metric_tags">Creating Metric Tags</h3>
<div class="listingblock">
<div class="title">Create gauge with tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/gauges -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "id": "request_size",
  "tags": {
    "datacenter": "dc1",
    "env": "stage"
    "units": "bytes"
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Create counter with tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/counters -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "id": "request_count",
  "tags": {
    "datacenter": "dc1",
    "env": "stage"
    "units": "bytes"
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Create availability with tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/availability -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "id": "server1",
  "tags": {
    "datacenter": "dc1",
    "env": "stage"
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_metric_tags">Updating Metric Tags</h3>
<div class="paragraph">
<p>These endpoints are used to add or replace tags.</p>
</div>
<div class="listingblock">
<div class="title">Update gauge tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X PUT http://server/hawkular/metrics/gauges/request_size/tags -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "datacenter": "dc2",
  "hostname": "server1"
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Update counter tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X PUT http://server/hawkular/metrics/counters/request_count/tags -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "datacenter": "dc2",
  "hostname": "server1"
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Update availability tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X PUT http://server/hawkular/metrics/availability/server1/tags -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "datacenter": "dc2",
  "hostname": "server1"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_metric_tags">Deleting Metric Tags</h3>
<div class="listingblock">
<div class="title">Delete gauge tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X DELETE http://server/hawkular/metrics/gauges/request_size/tags/env,status
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The request specifies a comma-delimited list of tag names. This request deletes the tags named <code>env</code> and <code>status</code>.</p>
</div>
<div class="listingblock">
<div class="title">Delete counter tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X DELETE http://server/hawkular/metrics/counters/request_count/tags/env,status
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Delete availability tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X DELETE http://server/hawkular/metrics/availability/server1/tags/env,status -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_point_tags">Data Point Tags</h3>
<div class="paragraph">
<p>Tags can be added to individual data points. They are a bit different than metric tags because they are immutable.
Tags cannot be added or updated after a data point is written. The following examples demonstrate how to add
tags to data points.</p>
</div>
<div class="listingblock">
<div class="title">Add gauge data points with tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/gauges/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {
    "id": "request_size",
    "data": [
      {
        "timestamp": 1460111065369,
        "value": 2048
        "tags": {
          "clientId": "1234",
          "zone": "us-east-1"
        }
      },
      {
        "timestamp": 1460151065369,
        "value": 2012,
        "tags": {
          "clientId": "5678",
          "zone": "us-west-1"
        }
      }
    ]
  },
  {
    "id": "request_time",
    "data": [
      {
        "timestamp": 1460111065369,
        "value": 2048,
        "tags": {
          "clientId": "1234",
          "zone": "us-east-1"
        }
      },
      {
        "timestamp": 1460151065369,
        "value": 2075,
        "tags": {
          "clientId": "5678",
          "zone": "us-west-1"
        }
      }
    ]
  }
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Add counter data points with tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/counters/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {
    "id": "request_count",
    "data": [
      {
        "timestamp": 1460111065369,
        "value": 2048
        "tags": {
          "clientId": "1234",
          "zone": "us-east-1"
        }
      },
      {
        "timestamp": 1460151065369,
        "value": 3107,
        "tags": {
          "clientId": "5678",
          "zone": "us-west-1"
        }
      }
    ]
  },
  {
    "id": "request_timeouts",
    "data": [
      {
        "timestamp": 1460111065369,
        "value": 11,
        "tags": {
          "clientId": "1234",
          "zone": "us-east-1"
        }
      },
      {
        "timestamp": 1460151065369,
        "value": 15,
        "tags": {
          "clientId": "5678",
          "zone": "us-west-1"
        }
      }
    ]
  }
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Add availability data points with tags</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/availability/raw -d @request.json \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">request.json</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {
    "id": "server1",
    "data": [
      {
        "timestamp": 1460111065369,
        "value": "up"
        "tags": {
          "clientId": "1234",
          "zone": "us-east-1"
        }
      },
      {
        "timestamp": 1460151065369,
        "value": "up",
        "tags": {
          "clientId": "5678",
          "zone": "us-west-1"
        }
      }
    ]
  },
  {
    "id": "server2",
    "data": [
      {
        "timestamp": 1460111065369,
        "value": "down",
        "tags": {
          "clientId": "1234",
          "zone": "us-east-1"
        }
      },
      {
        "timestamp": 1460151065369,
        "value": "down",
        "tags": {
          "clientId": "5678",
          "zone": "us-west-1"
        }
      }
    ]
  }
]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tag_filtering">Tag Filtering</h3>
<div class="paragraph">
<p>Hawkular Metrics provides a mini tag filtering expression language that is available in several query APIs. It has a
number of features including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Search by tag key only, ignoring the value</p>
<div class="ulist">
<ul>
<li>
<p>Only exact match searches are supported for tag keys</p>
</li>
</ul>
</div>
</li>
<li>
<p>Exact match search by key and value</p>
</li>
<li>
<p>Search for any number of tag values, i.e., logical OR</p>
</li>
<li>
<p>Regular expression support in tag value</p>
</li>
<li>
<p>Negation in tag value</p>
</li>
<li>
<p>Compound search filter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The remainder of this section provides several examples that illustrate the aforementioned features. Examples of how
tag filtering is supported in various APIs can be found in <a href="#_querying">Querying</a>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Example</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tag_name:*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zone:*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Search for tag named <code>zone</code> having any value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tag_name:value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zone:us-east-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Search for tag named <code>zone</code> having value <code>us-east-1</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tag_name:value1|value2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zone:us-east-1|us-west-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Search for tag named <code>zone</code> having a value of either <code>us-east-1</code>
or <code>us-west-1</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tag_name:!value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zone:!us-east-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Search for tag named <code>zone</code> with any value except <code>us-east-1</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tag_name:regex</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hostname:.*01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Search for tag named <code>hostname</code> with a value that ends with <code>01</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tag_name:value,tag_name:value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zone:us-east-1,hostname:dbserver01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Search for tag named <code>zone</code> with value <code>us-east-1</code>
and tag named <code>hostname</code> with value <code>dbserver01</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tag_name:value,tag_name:value1|value2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zone:us-east1,server:server01|server02</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Search for tag named <code>zone</code>
with value <code>us-east-1</code> and tag named <code>server</code> having a value of either <code>server01</code> or <code>server01</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_querying">Querying</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The examples provided in the following sections are not an exhaustive listing of the full API. For a complete reference
see the complete <a href="../../rest/rest-metrics.html">REST API documentation</a>.</p>
</div>
<div class="sect2">
<h3 id="_metric_definitions">Metric Definitions</h3>
<div class="paragraph">
<p>These operations do not fetch data points but rather the metric definition itself.</p>
</div>
<div class="sect3">
<h4 id="_query_for_metrics_of_specific_type">Query for Metrics of specific type</h4>
<div class="listingblock">
<div class="title">Fetch gauge definitions</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response body will look something like,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {
    "tenantId": "com.acme",
    "id": "gauge_1"
  },
  {
    "tenantId": "com.acme",
    "id": "gauge_2",
    "dataRetention": 20
  },
  {
    "tenantId": "com.acme",
    "id": "gauge_3",
    "dataRetention": 15,
    "tags": {
      "datacenter": "dc1",
      "hostname": "server01"
    }
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>gauge_1</code> has neither any tags nor data retention defined. It uses the tenant data retention. If that is not defined, it
uses the system default. <code>gauge_2</code> has its own data retention of 20 days. <code>gauge_3</code> has a data retention of 15 days and
also defines some tags.</p>
</div>
<div class="paragraph">
<p>Tag filter queries can be used to filter the list of metrics returned.</p>
</div>
<div class="listingblock">
<div class="title">Fetch counter definitions using tag filters</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/counters?tags=zone:us-west-1,kernel_version=4.0.9 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_query_across_all_metric_types">Query Across All Metric Types</h4>
<div class="paragraph">
<p>You can query across all metric types. The next example illustrates the <code>type</code> parameter which filters the results by
the specified types.</p>
</div>
<div class="listingblock">
<div class="title">Fetch all metric definitions</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/metrics \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">response body</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {
    "tenantId": "com.acme",
    "id": "gauge_1"
    "type": "gauge"
  },
  {
    "tenantId": "com.acme"
    "id": "gauge_2",
    "type": "gauge"
    "dataRetention": 20
  },
  {
    "tenantId": "com.acme",
    "id": "request_count",
    "type": "counter"
  },
  {
    "tenantId": "com.acme",
    "id": "request_timeouts",
    "type": "counter",
    "dataRetention": 20
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example demonstrates querying across all metric types and filtering the results using tag filters.</p>
</div>
<div class="listingblock">
<div class="title">Fetch all metric definitions with tag filters</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X POST http://server/hawkular/metrics/metrics?tags=zone:us-west-1,kernel_version=4.0.9 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_raw_data">Raw Data</h3>
<div class="paragraph">
<p>The simplest form of querying for raw data points does not require any parameters and returns a list of data points.
This API is available for each metric type.</p>
</div>
<div class="listingblock">
<div class="title">Simple request to fetch gauge data points</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hakwular/metrics/gauges/request_size/raw \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response with gauge data points</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {"timestamp": 1460413065369, "value": 3.14},
  {"timestamp": 1460212025569, "value": 4.57},
  {"timestamp": 1460111065369, "value": 5.056}
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Simple request to fetch counter data points</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hakwular/metrics/counters/request_count/raw \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response with counter data points</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {"timestamp": 1460413065369, "value": 7},
  {"timestamp": 1460212025569, "value": 11},
  {"timestamp": 1460111065369, "value": 19}
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Simple request to fetch availability data points</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hakwular/metrics/availability/server1/raw \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">response with availability data points</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {"timestamp": 1460413065369, "value": "up"},
  {"timestamp": 1460212025569, "value": "up"},
  {"timestamp": 1460111065369, "value": "down"}
]</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_date_range">Date Range</h4>
<div class="paragraph">
<p>Every query is bounded by a start and an end time. The end time defaults to <em>now</em>, and the start time defaults to 8
hours ago. These can be overridden with the <code>start</code> and <code>end</code> parameters respectively. The expected format of their
values is a unix timestamp. The start of the range is inclusive while the end is exclusive.</p>
</div>
<div class="listingblock">
<div class="title">Override start and end times for gauge</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges/request_size?start=1235,end=6789 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Override start and end times for counter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/request_count?start=1235,end=6789 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Override start and end times for availability</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/availability/server1?start=1235,end=6789 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the end time is greater than the start time, an error response will be returned with a 400 status code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sort_order">Sort Order</h4>
<div class="paragraph">
<p>Data is sorted by timestamp and returned in sorted order by default. The order is specified with the <code>order</code> parameter.
Accepted values are <code>asc</code> and <code>desc</code>. The parameter value is case-insensitive.</p>
</div>
<div class="listingblock">
<div class="title">Return results in ascending order for a gauge</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges/request_size?order=ASC \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Return results in ascending order for a counter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/request_count?order=ASC \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Return results in ascending order for an availability</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/availability/server1?order=ASC \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_limiting_results">Limiting Results</h4>
<div class="paragraph">
<p>By default there is no limit on the number of data points returned. The <code>limit</code> parameter will limit the number of data
points returned.</p>
</div>
<div class="listingblock">
<div class="title">Limit results for gauge</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges/request_size?limit=100 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Limit results for counter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/request_count?limit=100 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Limit results for availability</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/availability/server1?limit=100 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_counter_rates">Counter Rates</h3>
<div class="paragraph">
<p>Often times with counters, particularly with rendering graphs, we are more interested in rates. Hawkular Metrics
generates rate data points on the server side, freeing the client from that work. This is done at query time by simply
calculating the delta between raw counter data points. The result is multiplied by a factor of 60,000 milliseconds in
order to give us a per-minute rate.</p>
</div>
<div class="paragraph">
<p>Suppose we have the following counter data points:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Counter data points</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">60000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">90000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">210000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">300000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">550</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To fetch the rates for the counter:</p>
</div>
<div class="listingblock">
<div class="title">Fetch rate data points</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/request_count/rate</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Counter rates</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">[
  {"timestamp": 90000, "value": 400.00},
  {"timestamp": 210000, "value": 100.00},
  {"timestamp": 300000, "value": 100.00}
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the values are returned as floating point numbers.</p>
</div>
<div class="sect3">
<h4 id="_counter_resets">Counter Resets</h4>
<div class="paragraph">
<p>Sometimes there are events which occur counters to reset. For instance, suppose we are tracking the total number of
requests to a server since start up. Whenever the server is restarted, we will have a reset event. Hawkular Metrics
detects a reset event whenever a counter value is less than the previous value. If resets are not handled, they can
cause inconsistencies in graphs. Hawkular Metrics handles resets during rate calculations by excluding the data point
where the reset is detected. Let&#8217;s illustrate this with an example.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Counter data points with a reset event</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">60000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">90000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">210000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">130</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">300000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">180</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A reset event occurs some time between 90000 and 210000; consequently, we will get back the following rate data points:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Rate data points with reset</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">90000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">300000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">33.33</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that we exclude the rate data point between 90000 and 210000 timestamps.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_downsampling">Downsampling</h3>
<div class="paragraph">
<p>Downsampling is a query technique for reducing the number of data points that are sent back to the client. Why is this
done? When a request is made to render a graph, the client specifies a date range. The number of data points that fall
within that range can and will vary. We want to avoid sending back too many data points because an excessive number of
data points does little to improve the visualization, slows down the rendering, and makes the UI less responsive which
in turn makes the user experience worse overall. Downsampling is a way to return a predictable or fixed number of data
points which facilitates better graphs and a better overall user experience.</p>
</div>
<div class="paragraph">
<p>Hawkular Metrics provides several <code>/stats</code> endpoints that use downsampling. These endpoints are available for all
metric types. Examples are provided in <a href="#_querying_stats">Querying Stats</a>.</p>
</div>
<div class="sect3">
<h4 id="_buckets">Buckets</h4>
<div class="paragraph">
<p>Data points are first grouped into buckets. A bucket can have zero or more data points, and a data point will be in at
most one bucket. Aggregation functions are then applied to the data points in each bucket to produce a single,
<em>bucketed</em> data point.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at a simple example to illustrate how data points are grouped.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Data points</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data point</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>1</sub></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>2</sub></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>3</sub></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:20</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>4</sub></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>5</sub></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:40</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>6</sub></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:50</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We have six data points. The values are irrelevant for the example. We query with a date range of 15:00 to 16:00.
We use four buckets to end up with:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. Buckets</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bucket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data points</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:00 - 15:15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>1</sub>, P<sub>2</sub></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:15 - 15:30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>3</sub></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:30 - 15:45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>4</sub>, P<sub>5</sub></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15:45 - 16:00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P<sub>6</sub></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The first thing to note is that a bucket expressed as a date range or duration in which the start time is inclusive and
the end time is exclusive. If a data point&#8217;s timestamp falls within that range, then the data point is grouped into
that bucket. Different aggregation functions are applied depending on the metric type.</p>
</div>
<div class="sect4">
<h5 id="_bucket_query_parameters">Bucket Query Parameters</h5>
<div class="paragraph">
<p>There are two query parameters that are available with all <code>/stats</code> endpoints - <code>buckets</code> and <code>bucketDuration</code>. One and
only one of them can be specified in a request. For the preceding example, we could end up with four buckets using
either one these parameters.</p>
</div>
<div class="paragraph">
<p><code>buckets</code> specifies the exact number of buckets to use. For the preceding example, <code>buckets=4</code> will divide the time
range into four buckets. A higher value increases the number of buckets which in turn reduces the number of data points
per bucket.</p>
</div>
<div class="paragraph">
<p><code>bucketDuration</code> is a duration specified in one of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>milliseconds</p>
</li>
<li>
<p>seconds</p>
</li>
<li>
<p>minutes</p>
</li>
<li>
<p>hours</p>
</li>
<li>
<p>days</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The value must match the regular expression <code>(+d)(ms|s|mn|h|d)</code>.</p>
</div>
<div class="paragraph">
<p>For the preceding example, <code>bucketDuration=900000ms</code> specifies a duration of 900,000 milliseconds or 15 minutes to
yield four buckets.</p>
</div>
<div class="paragraph">
<p>Alternatively, we could do <code>bucketDuration=900s</code> which is 900 seconds or 15 minutes.</p>
</div>
<div class="paragraph">
<p>We could also do <code>bucketDuration=15mn</code> which is 15 minutes.</p>
</div>
<div class="paragraph">
<p>Suppose our date range spanned a 7 day period and we want a bucket per day. We could accomplish this with
<code>bucketDuration=24h</code> which is 24 hours or 1 day. Alternatively we could do <code>bucketDuration=1d</code> which is 1 day.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A larger duration results in fewer buckets with more data points per bucket. A smaller duration results in more
buckets with less data points per bucket.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_numeric_bucket_data_points">Numeric Bucket Data Points</h4>
<div class="paragraph">
<p>Numeric bucket data points are used with gauges, counters, and rates. When data points are grouped into a bucket,
several aggregation functions are applied to produce a data point that consists of a number of statistics.</p>
</div>
<div class="listingblock">
<div class="title">Numeric bucket data point</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "start": 12345,
  "end": 6789,
  "empty": false,
  "min": 100.01,
  "avg": 107.5,
  "max": 115.32,
  "median": 109.0,
  "sum": 215.0,
  "samples": 5
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>start</code> and <code>end</code> correspond to the bucket&#8217;s start and end times respectively.</p>
</div>
<div class="paragraph">
<p><code>empty</code> is a boolean flag that indicates whether or not the bucket has any data points in it. We will see an example of
an empty bucket next.</p>
</div>
<div class="paragraph">
<p>The <code>min</code>, <code>max</code>, <code>avg</code>, <code>median</code>, and <code>sum</code> properties should be self-explanatory. They hold the results of the
aggregation functions applied over all the data points in the bucket.</p>
</div>
<div class="paragraph">
<p><code>samples</code> is the total number of data points in the bucket.</p>
</div>
<div class="paragraph">
<p>The properties in a numeric data point are fixed and are the same for gauges, counters, and rates.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the future, Hawkular Metrics may allow the client to specify which aggregation functions to use in the bucket
data points. See <a href="https://issues.jboss.org/browse/HWKMETRICS-374">HWMKETRICS-374</a> for details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s see what an empty bucket data point looks like.</p>
</div>
<div class="listingblock">
<div class="title">Empty numeric bucket data point</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "start": 12345,
  "end": 6789,
  "empty": true,
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>empty</code> property is true indicating that there were no data points in the bucket. Note that the statistics related
properties are excluded when the bucket is empty.</p>
</div>
<div class="paragraph">
<p>A bucket data point can also have an optional set of percentiles.</p>
</div>
<div class="listingblock">
<div class="title">Bucket data point with percentiles</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "start": 12345,
  "end": 6789,
  "empty": false,
  "min": 100.01,
  "avg": 107.5,
  "max": 115.32,
  "median": 109.0,
  "sum": 215.0,
  "percentiles": [
    {
      "quantile": 0.90,
      "value": 100.01
    },
    {
      "quantile": 0.95
      "value": 108.42
    },
    {
      "quantile": 0.99
      "value": 115.25
    }
  ]
  "samples": 5
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This data point includes the 90th, 95th, and 99th percentiles. Unless the request explicitly asks for percentiles, they
will be omitted. See <a href="#percentiles-param-with-gauge">this example below</a> to see how the <code>percentiles</code> query parameter
is used..</p>
</div>
</div>
<div class="sect3">
<h4 id="_querying_stats">Querying Stats</h4>
<div class="paragraph">
<p>This section provides examples of all the <code>/stats</code> endpoints for the different metric types.</p>
</div>
</div>
<div class="sect3">
<h4 id="_querying_gauges">Querying Gauges</h4>
<div class="listingblock">
<div class="title">Fetch gauge stats using buckets parameter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges/request_size/stats?start=1235&amp;end=6789&amp;buckets=60 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request queries a gauge named <code>request_size</code> and specifies that 60 buckets be used. An array of numeric bucket
data points is returned.</p>
</div>
<div class="listingblock">
<div class="title">Fetch gauge stats using bucketDuration parameter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges/request_size/stats?start=1235&amp;end=6789&amp;bucketDuration=60000ms \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request uses the <code>bucketDuration</code> parameter and specifies that each bucket is a minute wide.</p>
</div>
<div class="paragraph">
<p>The next example demonstrates the <code>percentiles</code> query parameter.</p>
</div>
<div id="percentiles-param-with-gauge" class="listingblock">
<div class="title">Fetch gauge stats that include percentiles</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges/request_size/stats?start=1235&amp;end=6789&amp;buckets=30&amp;percentiles=75,90,99 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>percentiles</code> parameter takes a comma-delimited list of numeric values in which each value must be between 0 and
100.</p>
</div>
<div class="paragraph">
<p>You can also query across multiple gauges. The set of metrics to query is determined by using either tag filters or by
specifying a list of metric names.</p>
</div>
<div class="listingblock">
<div class="title">Fetch stats from multiple gauges by name</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges/stats?start=12345&amp;end=56789&amp;buckets=100&amp;metrics=G1&amp;metrics=G2&amp;metrics=G3</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request fetches data points from gauges G1, G2, and G3. The only difference from previous examples is that each
bucket will contain data points from multiple metrics.</p>
</div>
<div class="paragraph">
<p>Next we use tag filters to select the set of metrics to query.</p>
</div>
<div class="listingblock">
<div class="title">Fetch stats from gauges using tag filters</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges/stats?start=1235&amp;end=6789&amp;buckets=30&amp;tags=hostname:server1 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_querying_counters">Querying Counters</h4>
<div class="paragraph">
<p>Now we look at the <code>/stats</code> endpoints for counter which are virtually the same as those for gauges.</p>
</div>
<div class="listingblock">
<div class="title">Fetch counter stats using buckets parameter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/total_requests/stats?start=1235&amp;end=6789&amp;buckets=60 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request queries a counter named <code>total_requests</code> and specifies that 60 buckets be used. An array of numeric bucket
data points is returned.</p>
</div>
<div class="listingblock">
<div class="title">Fetch counter stats using bucketDuration parameter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/total_requests/stats?start=1235&amp;end=6789&amp;bucketDuration=60s \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request uses the <code>bucketDuration</code> parameter and specifies that each bucket is a minute wide.</p>
</div>
<div class="listingblock">
<div class="title">Fetch counter stats that include percentiles</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/total_requests/stats?start=1235&amp;end=6789&amp;buckets=30&amp;percentiles=75,90,99 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also query across multiple counter. The set of metrics to query is determined by using either tag filters or by
specifying a list of metric names.</p>
</div>
<div class="listingblock">
<div class="title">Fetch stats from multiple counters by name</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/stats?start=12345&amp;end=56789&amp;buckets=100&amp;metrics=C1&amp;metrics=C2&amp;metrics=C3</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request fetches data points from counters C1, C2, and C3. The only difference from previous examples is that each
bucket will contain data points from multiple metrics.</p>
</div>
<div class="paragraph">
<p>Next we use tag filters to select the set of metrics to query.</p>
</div>
<div class="listingblock">
<div class="title">Fetch stats from counters using tag filters</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/stats?start=1235&amp;end=6789&amp;buckets=30&amp;tags=hostname:server1 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_querying_counter_rates">Querying Counter Rates</h4>
<div class="paragraph">
<p>Downsampling can be done with rates as well.</p>
</div>
<div class="listingblock">
<div class="title">Fetch rates stats using buckets parameter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/total_requests/rate/stats?start=1235&amp;end=6789&amp;buckets=60 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request queries the rate for a counter named <code>total_requests</code> and specifies that 60 buckets be used. An array of
numeric bucket data points is returned.</p>
</div>
<div class="listingblock">
<div class="title">Fetch rate stats using bucketDuration parameter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/total_requests/rate/stats?start=1235&amp;end=6789&amp;bucketDuration=1mn \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request uses the <code>bucketDuration</code> parameter and specifies that each bucket is a minute wide.</p>
</div>
<div class="listingblock">
<div class="title">Fetch rate stats that include percentiles</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/total_requests/rate/stats?start=1235&amp;end=6789&amp;buckets=30&amp;percentiles=75,90,99 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also query for rates across multiple counter. The set of metrics to query is determined by using either tag
filters or by specifying a list of metric names.</p>
</div>
<div class="listingblock">
<div class="title">Fetch rate stats from multiple counters by name</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/rate/stats?start=12345&amp;end=56789&amp;buckets=100&amp;metrics=C1&amp;metrics=C2&amp;metrics=C3</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request fetches rate data points from counters C1, C2, and C3. The only difference from previous examples is that each
bucket will contain data points from multiple metrics.</p>
</div>
<div class="paragraph">
<p>Next we use tag filters to select the set of metrics to query.</p>
</div>
<div class="listingblock">
<div class="title">Fetch rate stats from counters using tag filters</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/counters/rate/stats?start=1235&amp;end=6789&amp;buckets=30&amp;tags=hostname:server1 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_availability_bucket_data_points">Availability Bucket Data Points</h4>
<div class="paragraph">
<p>Availability bucket data points are used with availability metrics. When data points are grouped into a bucket, several
aggregation functions are applied to produce a data point that consists of several of statistics.</p>
</div>
<div class="listingblock">
<div class="title">Availability bucket data point</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "start": 12345,
  "end": 6789,
  "empty": false,
  "downtimeDuration": 29311,
  "lastDowntime": 12367,
  "uptimeRatio": 0.78,
  "downtimeCount": 12
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>start</code> and <code>end</code> correspond to the bucket&#8217;s start and end times respectively.</p>
</div>
<div class="paragraph">
<p><code>empty</code> is a boolean flag that indicates whether or not the bucket has any data points in it. We will see an example of
an empty bucket next.</p>
</div>
<div class="paragraph">
<p><code>downtimeDuration</code> is the total time in milliseconds that the metric was reported down. Note that this is the total
time within the bucket&#8217;s start and end times.</p>
</div>
<div class="paragraph">
<p><code>lastDowntime</code> is the last time within the bucket&#8217;s time range that the metric was reported down. The value is in
milliseconds.</p>
</div>
<div class="paragraph">
<p><code>uptimeRatio</code> is basically a percentage of the time for the duration of the bucket that the metric is up. The value
will be a floating point number between zero and one.</p>
</div>
<div class="paragraph">
<p><code>downtimeCount</code> is the number of periods in which a resource is reported down. In this context a period is a range of
consecutive data points in which the availability does not change. For example, if a resource reports down twice in a
row, then up, and then down again, <code>downtimeCount</code> will be 2.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at what an empty data point looks like.</p>
</div>
<div class="listingblock">
<div class="title">Empty availability bucket data point</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
  "start": 12345,
  "end": 6789,
  "empty": true,
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the statistics related properties are omitted when the bucket is empty.</p>
</div>
</div>
<div class="sect3">
<h4 id="_querying_availability">Querying Availability</h4>
<div class="listingblock">
<div class="title">Fetch availability stats using buckets parameter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/gauges/server1/stats?start=1235&amp;end=6789&amp;buckets=60 \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request queries an availability metric named <code>server1</code> and specifies that 60 buckets be used. An array of
availability bucket data points is returned.</p>
</div>
<div class="listingblock">
<div class="title">Fetch availability stats using bucketDuration parameter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">curl -X GET http://server/hawkular/metrics/availability/server1/stats?start=1235&amp;end=6789&amp;bucketDuration=60s \
-H "Content-Type: application/json" -H "Hawkular-Tenant: com.acme"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request uses the <code>bucketDuration</code> parameter and specifies that each bucket is a minute wide.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
There is currently no API for fetching bucket data points across multiple availability metrics.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_alerting">Alerting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hawkular Metrics includes Hawkular Alerting.  This allows users to quickly leverage their metric data
with robust alerting.</p>
</div>
<div class="paragraph">
<p>Triggers can be defined to act on both the incoming stream of metrics (near real time) or via queries
of the persisted metric data. This combination of stream and query-based alerting can be powerful.</p>
</div>
<div class="paragraph">
<p>It may be useful to get familiar with the capabilities and terminology of Hawkular Alerting before getting
into the details of using it with Hawkular Metrics.  For more see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.hawkular.org/community/docs/developer-guide/alerts.html">Hawkular Alerting User Guide</a></p>
</li>
<li>
<p><a href="http://www.hawkular.org/docs/rest/rest-alerts.html">Hawkular Alerting REST API</a></p>
</li>
<li>
<p><a href="http://github.com/hawkular/hawkular-alerts/tree/master/examples">Hawkular Alerting Examples</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_stream_based_alerting">Stream-Based Alerting</h3>
<div class="paragraph">
<p>This approach defines triggers using Alerting&#8217;s built-in condition types and evaluates the conditions
on the incoming metric data. It provides the fastest possible issue detection.  For example, given a response time
gauge metric named MyAppResponseTime, a trigger could be defined with Threshold condition (MyAppResponseTime &gt; 750).
There are many condition types and trigger options but the main point here is that the threshold test is evaluated
on incoming metric data, as it is being persisted.</p>
</div>
<div class="sect3">
<h4 id="_metricid_prefixes">MetricId Prefixes</h4>
<div class="paragraph">
<p>There is one technical note.  To use Hawkular Alerting with Hawkular Metrics there is a naming convention
when defining trigger conditions. For a metric with name 'X', the alerting DataId to reference it will be
'prefix_X', where the prefix depends on the metric&#8217;s type. For example, the MyAppResponseTime metric,
used above, is a 'gauge'. The 'hm_g' prefix would be used.  So, the actual condition would be defined as
(hm_g_MyAppResponseTime &gt; 750).</p>
</div>
<div class="paragraph">
<p>This is done because Hawkular Metrics allows the same metric name for different types, and Hawkular Alerting
then needs the prefix to uniquely identify the correct metric.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. Metric Prefixes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Prefix</th>
<th class="tableblock halign-left valign-top">Metric Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hm_a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">availability</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hm_c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">counter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hm_cr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">counter rate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hm_g</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gauge</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hm_gr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gauge rate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hm_s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_query_based_alerting">Query-Based Alerting</h3>
<div class="paragraph">
<p>Whereas stream-based alerting is applied to metric data as it arrives, it is often the case that issues
can be detected by looking at historical behavior of the persisted data.  Hawkular Metrics provides its
own <a href="http://www.hawkular.org/community/docs/developer-guide/alerts.html#_external_alert_integration">Alerter</a>
to provide this capability. An Alerter extends Hawkular Alerting by allowing external condition evaluators.
In this case, the Metrics Alerter performs queries looking for user-defined conditions, and when found it
then informs Hawkular Alerting, which in turn may fire a trigger and generate an alert.</p>
</div>
<div class="paragraph">
<p>The mechanism is the same as when defining a stream-based trigger, except in this case the trigger uses
an ExternalCondition.  The ExternalCondition supplies an expression string that is understood and processed by
the alerter.  The metrics alerter defines a robust language for defining the external condition
expression string.</p>
</div>
<div class="sect3">
<h4 id="_expression_language">Expression Language</h4>
<div class="paragraph">
<p>The expression language allows the user to define one or more queries which can then be incorporated
into a flexible eval expression.  For example, let&#8217;s say we want to detect an increase in response
time day over day, using the MyAppResponseTime metric.  We&#8217;d define two queries, let&#8217;s call them
qNow and q1d.  qNow will query for the most recent MyAppResponseTime data and q1d will query the
for data 1 day back.  Additionally, our queries would define the duration, let&#8217;s say one hour.  So,
to detect a 25% increase in the average response time for the most recent hour, compared to the average
for the same hour yesterday, we could define an eval expression like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  ( q(qNow,avg) &gt; ( 1.25 * q(q1d,avg) ) )</pre>
</div>
</div>
<div class="paragraph">
<p>The eval expressions are built on EvalEx and support many operators and built-in functions.  See
<a href="https://github.com/uklimaschewski/EvalEx">EvalEx</a> for a complete description of supported
operators, functions and constants.</p>
</div>
<div class="paragraph">
<p>The query variables are of the format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  q(&lt;queryName&gt;,&lt;function&gt;)</pre>
</div>
</div>
<div class="paragraph">
<p>Each query variable will be replaced by the actual data fetched from Hawkular Metrics, and then
the eval expression will be evaluated.  If the evaluation returns true then Hawkular Alerting is
informed such that the ExternalCondition matches, potentially firing a trigger.</p>
</div>
<div class="paragraph">
<p>The queryName refers to one of the queries defined in the expression.  The functions available
depend on the MetricType of the data being queried, and are analogous to the /stats endpoints
in the Metrics REST API.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. Query Functions</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">MetricType</th>
<th class="tableblock halign-left valign-top">Available Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gauge, Gauge Rate, Counter, Counter Rate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">avg, max, median, min, percentiles, samples, sum</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Availability</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">notUpCount, notUpDuration, samples, upCount, uptimeRatio</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not supported by the Alerter, use Stream-Based conditions</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_percentiles">Percentiles</h5>
<div class="paragraph">
<p>The percentiles available depend on the percentiles requested in the query definition. By default
no percentiles are available.  But, requested percentiles can be referenced in the query function.
For example, the 90th percentile would be referenced like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  q(qNow,%90)</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_other_examples">Other Examples</h5>
<div class="paragraph">
<p>If 90th percentile &gt; twice the median</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  ( q(qNow,%90) &gt; ( 2 * q(qNow,median) ) )</pre>
</div>
</div>
<div class="paragraph">
<p>If &lt; 2 heartbeat avails have been reported in the last minute</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  ( q(qNow,upCount) &lt; 2 )</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_conditionexpression">ConditionExpression</h4>
<div class="paragraph">
<p>The ConditionExpression fully defines the condition to be evaluated. It is defined as follows and
is supplied as a JSON string (the ExternalCondition&#8217;s expression value must be a String).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ConditionExpression
  queries        List&lt;Query&gt;
  frequency      duration string (see below), time between query-executions/evals
  eval           string, expression determining condition match
  evalType       string, one of [ALL (default), EACH]. See more below.


Query
  name           string, for referencing the query in the eval
  type           string, optional, target metric type for query (default=gauge)
  metrics        Set&lt;String&gt; of metricIds (see more below)
                   required if tags not specified, otherwise not permitted
  tags           string, a metrics 'tag query expression' (see more below)
                   required if metrics not specified, otherwise not permitted
  percentiles    Set&lt;String&gt;, optional, requested percentiles (e.g. {"90","95"})
  duration       duration string (see below)
                   defines length of time range for data to be queried
  offset         duration string (see below), optional
                   defines time range offset, Default is no offset.
                     - start = now - offset - duration
                     - end = start + duration</pre>
</div>
</div>
<div class="sect4">
<h5 id="_evaltype">EvalType</h5>
<div class="paragraph">
<p><code>ConditionExpression.evalType</code> determines whether the eval expression is performed on <strong>ALL</strong> or <strong>EACH</strong> of the metrics. The <code>Query.metrics</code> and <code>Query.tags</code> fields define the set of metrics that will be involved in the query. The query will result in a set of data points for each metric. This field defines how to perform the <code>ConditionExpression.eval</code> for the resulting data points.</p>
</div>
<div class="paragraph">
<p><strong>ALL:</strong> The data points for all of the metrics will be combined, then aggregated, and <code>ConditionExpression.eval</code> is resolved one time (per run of the ConditionExpression). At most one Event will be sent to Alerting if <code>ConditionExpression.eval</code> resolves to true.</p>
</div>
<div class="paragraph">
<p><strong>EACH:</strong> The data points for each metric will be aggregated separately. <code>ConditionExpression.eval</code> is resolved N times, once for each metric. Up to N Events
could be sent to Alerting depending on how often <code>ConditionExpression.eval</code> resolves to true.</p>
</div>
<div class="paragraph">
<p>For example, assume we are dealing with two metrics, M1 and M2, the eval is <code>q(qNow,avg) &gt; 100</code>, and qNow is define with an interval of 1h. On each run we get the M1 and M2 data points for the most recent hour. Using <strong>ALL</strong> we combine all of the datapoints, generate the average, and resolve the expression. If true we send an Event to alerting.  Using <strong>EACH</strong> we keep the data points for each metric separate, generate the average for each, and resolve the expression for each. For each true resolution we send an Event to Alerting.  Note that to distinguish the events we provide the metric name in the <code>Event.context</code>. For example: context={"MetricName":"M1"}.</p>
</div>
<div class="paragraph">
<p>A note about using <strong>EACH</strong>.  If multiple queries are involved in the eval expression then that only metrics common to each query will be evaluated.  For example, if the eval above were <code>q(qNow,avg) &gt;  q(qYesterday,avg)</code> and only M1 were common to both queries then the eval would only be resolved using M1 data points.  In general each query will likely use the same metrics so this issue is a corner case.</p>
</div>
<div class="paragraph">
<p>The default is ALL.</p>
</div>
</div>
<div class="sect4">
<h5 id="_metrics_and_tags">Metrics and Tags</h5>
<div class="paragraph">
<p>The <code>Query.metrics</code> and <code>Query.tags</code> fields are used to specify the metrics involved in the query, and therefore the data being retrieved. One of the fields must be specified. They are mutually exclusive, so specifying both is an error.</p>
</div>
</div>
<div class="sect4">
<h5 id="_duration">Duration</h5>
<div class="paragraph">
<p>Fields specified as a Duration follow the standard <a href="http://www.hawkular.org/docs/rest/rest-metrics.html#_custom_string_formats">Duration format</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_events_sent_to_alerting">Events Sent to Alerting</h5>
<div class="paragraph">
<p>When <code>ConditionExpression</code>.eval resolves to true the Alerter sends an Event to Alerting.  The Event is designed to match the ExternalCondition from which the expression was built:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 8. Event</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tenantId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ExternalCondition&#8217;s tenantId (from the owning Trigger)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A generated UUID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ctime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">current time in ms</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ExternalCondition&#8217;s dataId</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">category</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"MetricsCondition"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Values used in eval (e.g. "{q(qNow,avg)=61.0}")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"MetricName":&lt;EvalMetricName&gt;  (Map entry provided when EvalType=EACH)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Events are for matching only and are not persisted in the Alerting database.  Although, for any generated Alert the the Event will be provided in the <code>Alert.conditionEvals</code> in order to help explain the Alert.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_generating_the_json">Generating the JSON</h4>
<div class="paragraph">
<p>The ConditionExpression JSON can be generated by hand, but it may be easier to utilize
the provided Java classes. (TODO: Determine where these classes should be provided and provide
Maven dependency).  To generate the JSON construct the ConditionExpression and then call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  ConditionExpression.toJson()</pre>
</div>
</div>
<div class="paragraph">
<p>The following Code snippet from AlerterITest.groovy is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Query qNow = new Query("qNow", Collections.singleton(metricId), null, null, ResultType.combined, "1mn", null);
Query q1d = new Query("q1d", "1d", qNow);
ConditionExpression ce = new ConditionExpression( Arrays.asList(qNow, q1d), "1h",
            "((q(qNow,avg) - q(q1d,avg)) / q(q1d,avg)) &gt; 0.25" )
println( JsonOutput.prettyPrint( ce.toJson()) )</pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "queries": [
        {
            "name": "qNow",
            "type": "gauge",
            "metrics": [
                "alerts-test-avgd-1484757539171"
            ],
            "tags": null,
            "percentiles": [
                "90"
            ],
            "duration": "1h",
            "offset": null
        },
        {
            "name": "q1d",
            "type": "gauge",
            "metrics": [
                "alerts-test-avgd-1484757539171"
            ],
            "tags": null,
            "percentiles": [
                "90"
            ],
            "duration": "1h",
            "offset": "1d"
        }
    ],
    "frequency": "30mn",
    "evalType": "ALL",
    "eval": "(q(qNow,avg) &gt; ( 1.25 * q(q1d,avg)))"
}</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security">Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>TODO</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_links">Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Please visit the following pages for more details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="../../../docs/rest/rest-metrics.html">Metrics - REST API documentation</a></p>
</li>
<li>
<p><a href="https://github.com/hawkular/hawkular-metrics">GitHub Repository</a></p>
</li>
<li>
<p><a href="installation.html">Installation Guide</a></p>
</li>
<li>
<p><a href="configuration.html">Configuration Guide</a></p>
</li>
<li>
<p><a href="../../../hawkular-clients/grafana/docs/quickstart-guide">Grafana integration</a></p>
</li>
</ul>
</div>
</div>
</div>
      </div>
    </section>
<div class="container">
      <p><strong>Tags:</strong> 
            | <a href="/tags/hawkular-metrics.html">hawkular-metrics</a> 
            | <a href="/tags/metrics.html">metrics</a> 
         | </p>
      </div>  

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../../js/jbossorg-tabzilla.js"></script>
    <script src="../../../js/behavior.js"></script>
    <script src="../../../js/prettify.js"></script>
    <script src="../../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
