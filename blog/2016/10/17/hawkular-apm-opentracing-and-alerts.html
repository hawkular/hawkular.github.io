<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Hawkular APM supports OpenTracing and Alerts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link href="../../../../css/tabzilla.css" rel="stylesheet">
    <link href="../../../../css/styles.css" rel="stylesheet">
    <link href="../../../../css/prettify.css" rel="stylesheet">
    <link href="../../../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../../../js/moment.min.js"></script>
    <script src="../../../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">

	
<!-- Fixed navbar -->
<nav class="navbar navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <a class="navbar-brand" href="../../../..//">Home</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="../../../../blog.html" role="button">Blog</a></li>
        <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
          Community
          <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li class="menu-item">
              <a href="../../../../community/docs/getting-involved/">Getting Involved</a>
            </li>
            <li class="menu-item">
              <a href="../../../../community/docs/developer-guide/">Developer Guide</a>
            </li>
            <li class="menu-item dropdown dropdown-submenu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                <ul class="dropdown-menu">
                  <li class="menu-item ">
                    <a href="../../../../community/labs/datamining/">Datamining</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../../../hawkular-clients/android-client/">Android client</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                  </li>
                </ul>
            </li>
            <li>
              <a href="https://github.com/hawkular">GitHub Repositories</a>
            <li>
              <a href="https://travis-ci.org/hawkular">CI Builds</a>
            </li>
          </ul>
        </li>
      </ul>
      <div id="wrap">
        <div class="dropup">
          <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
          <script>
            window.addEventListener('load', function() {
              renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
          </script>
        </div>
      </div>
    </div>
</nav>

    <section class="main-banner blog-mainbanner">
        <div class="container">
            <h1>Hawkular APM supports OpenTracing and Alerts</h1>
            <p>A blog post by Gary Brown</p>
<!-- show tags for this page -->
   <p> 
      <a href="/tags/apm.html">apm</a> 
          |
      <a href="/tags/microservice.html">microservice</a> 
          |
      <a href="/tags/opentracing.html">opentracing</a> 
          |
      <a href="/tags/vertx.html">vertx</a> 
  </p>
        </div>
    </section>

    <div class="blog-container">
        <br/><br/>
    	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/hawkular/hawkular-apm/releases/tag/0.11.0.Final">latest Hawkular APM release</a> includes two new features, a Java based <a href="http://opentracing.io/">OpenTracing</a> provider and integration with <a href="http://www.hawkular.org/community/docs/developer-guide/alerts.html">Hawkular Alerts</a>.</p>
</div>
<div class="paragraph">
<p>A video demonstrating these new features can also be viewed <a href="https://youtu.be/HSWSiww07RE">here</a>. The video starts with an explanation of how a vertx application is instrumented using OpenTracing. If you want to skip that explanation, then start <a href="https://youtu.be/HSWSiww07RE?t=7m47s">here for an explanation of the alert trigger</a> or start <a href="https://youtu.be/HSWSiww07RE?t=9m20s">here for the actual demo</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_an_example_vertx_application_instrumented_using_opentracing">An Example Vertx Application instrumented using OpenTracing</h3>
<div class="paragraph">
<p>As explained on the <a href="http://opentracing.io/">OpenTracing Website</a>, it is <em>"A vendor-neutral open standard for distributed tracing"</em>.</p>
</div>
<div class="paragraph">
<p>The project has been established to provide a consistent API, across multiple languages, to enable applications to be independent of any particular tracing solution. The currently supported languages are Java, Javascript, Go, Python, Objective-C and C++.</p>
</div>
<div class="paragraph">
<p>As part of the most recent <a href="https://github.com/hawkular/hawkular-apm/releases/tag/0.11.0.Final">Hawkular APM release (version 0.11)</a> we have implemented a Java based OpenTracing provider. To help demonstrate its use, we have instrumented an example <a href="http://vertx.io/">Vert.x</a> application that uses an asynchronous programming style with different interaction patterns (request/response and publish/subscribe). The code for the example can be found on <a href="https://github.com/hawkular/hawkular-apm/tree/0.11.0.Final/examples/vertx-opentracing">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>Adding OpentTracing instrumentation to an application essentially involves creating a set of spans to demarcate significant points in your application that you wish to monitor. When a service receives a request from a client, it should first attempt to extract any existing state information from the client request before creating the top level span for the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>        SpanContext spanCtx = tracer.extract(Format.Builtin.TEXT_MAP,
                new HttpHeadersExtractAdapter(routingContext.request().headers()));

        Span ordersConsumerSpan = tracer.buildSpan("POST")
                .asChildOf(spanCtx)
                .withTag("http.url", "/orders")
                .withTag("service", "OrderManager")
                .withTag("transaction", "Place Order")
                .start();</code></pre>
</div>
</div>
<div class="paragraph">
<p>So in this case, we are receiving a request to place an order via a RESTful endpoint (i.e. POST /orders). The first statement extracts any trace state from the HTTP headers and stores them in a <em>SpanContext</em> which is then used when creating a <em>childOf</em> relationship for the top level span.</p>
</div>
<div class="paragraph">
<p>The additional tags we have specified are for information purposes. The <code>http.url</code> is used to identify two things, that the endpoint type is HTTP, and secondly the URL is <em>/orders</em>. The <code>service</code> tag is used to add information on the dependency graph, and finally the <code>transaction</code> enables the trace instance to be classified as belonging to this business transaction.</p>
</div>
<div class="paragraph">
<p>As this service is then making calls out to other services, we want to create a span to encapsulate the service invocation, and identify it as being a child span of the previously created span (i.e. to make it clear that this service invocation is being performed in the scope of the existing trace instance). The follow span represents the call out to the <em>AccountManager</em> to get account information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>        Span getAccountSpan = tracer.buildSpan("GetAccount")
                .asChildOf(ordersConsumerSpan)
                .start();

        tracer.inject(getAccountSpan.context(), Format.Builtin.TEXT_MAP,
                new VertxMessageInjectAdapter(order));

        eb.send("AccountManager.getAccount", order, acctresp -&gt; {
            getAccountSpan.finish();
            ....</code></pre>
</div>
</div>
<div class="paragraph">
<p>After creating the span, the second statement is used to <em>inject</em> the trace state into the message being sent to the <em>AccountManager</em>. This is necessary to ensure that the activities that occur within the account manager are linked to the same trace instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>        response.putHeader("content-type", "application/json")
                .setStatusCode(202).end(order.encodePrettily());

        ordersConsumerSpan.setTag("orderId", order.getString("id"));
        ordersConsumerSpan.setTag("itemId", order.getString("itemId"));
        ordersConsumerSpan.setTag("accountId", order.getString("accountId"));

        ordersConsumerSpan.finish();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, once the order has been confirmed, we associate some additional information with the top level span, before calling the <code>finish()</code> method.</p>
</div>
<div class="paragraph">
<p>This gives a brief insight into how an application can be instrumented to use the OpenTracing API. The <em>OrderManager</em> example is slightly more complex, in that it also instruments a subsequent publish of the order confirmation on the event bus, and relates the instrumentation back to the original trace using the <em>FOLLOWS_FROM</em> reference type. For more information please see the <a href="https://github.com/hawkular/hawkular-apm/tree/0.11.0.Final/examples/vertx-opentracing">code</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_analysing_the_captured_information">Analysing the Captured Information</h3>
<div class="paragraph">
<p>When starting the Hawkular APM console, the first page that is displayed shows details for the spans associated with the tracing information that has been captured from the application. The spans can represent <em>Consumers</em> that receive service requests, <em>Producers</em> that make service requests, or internal <em>Components</em> (e.g. databases).</p>
</div>
<div class="paragraph">
<p>As you can see, the values in the <em>Operation</em> column have the same values that were used when building the spans in the vertx application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-10-17-apm-vertx-components.png" alt="Application component details">
</div>
</div>
<div class="paragraph">
<p>On the <strong>Distributed Tracing</strong> page, we can view the dependencies between the services that were involved in placing the order (i.e. we have selected the <em>Place Order</em> business transaction). We could also filter based on individual properties to further refine the trace instances that are aggregated into this view.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-10-17-apm-vertx-dt.png" alt="Service dependencies">
</div>
</div>
<div class="paragraph">
<p>If we then select the <strong>Show 'n' instance details</strong> button, and select an instance from the table, you can view the flow of the individual trace instance:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-10-17-apm-vertx-instance.png" alt="Trace instance for placing an order">
</div>
</div>
<div class="paragraph">
<p>In this diagram, you can see how the order is first passed to the <em>AccountManager</em> to check the account id is known, followed by the <em>InventoryManager</em> to check the stock level. At this point the order confirmation is created and returned to the client application.</p>
</div>
<div class="paragraph">
<p>However this is not the end of the trace, as the Vertx application then publishes the order confirmation on the event bus, which is consumed by two services (<em>OrderLog</em> and <em>InventoryManager</em>) - which demonstrates tracing a publish/subscribe interaction. This behaviour is represented by a dotted line, as it is being performed concurrently, outside the scope of the main request/response interaction with the client application.</p>
</div>
<div class="paragraph">
<p>The following screenshot is the <strong>Business Transaction</strong> page, which shows a summary of the business transactions being managed by the server. In previous releases, the business transactions were configured on the server, based on information captured using the non-intrusive agent based approach.</p>
</div>
<div class="paragraph">
<p>With the explicit instrumentation of applications using the OpenTracing API, we have added the ability for the application to directly specify the name of the business transaction, which is then propagated with the trace state between interacting services. This means that business transactions don&#8217;t need to be configured on the server when specified via the OpenTracing API.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-10-17-apm-vertx-btxnsummary.png" alt="Summary of business transactions">
</div>
</div>
<div class="paragraph">
<p>When a business transaction is selected from the summary page, it shows the detailed information:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-10-17-apm-vertx-btxn-placeorder.png" alt="Place order business transaction information">
</div>
</div>
<div class="paragraph">
<p>This screenshot shows how information specified via tags on the OpenTracing spans can be used to show faults and properties for the business transaction. Selecting the segments in the fault and properties pie charts can be used to further filter the information displayed on this page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_summary">Summary</h3>
<div class="paragraph">
<p>In this blog and accompanying video we have shown how Hawkular APM can be used with an application instrumented using the standard OpenTracing API. The video also shows how trace information captured and reported to the Hawkular APM server can be used to trigger alerts defined using Hawkular Alerts.</p>
</div>
</div></p>
    	<hr /><br /><br />

        <p><em>Published by Gary Brown on  17 October 2016</em></p>

    <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'hawkular';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../../../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../../../js/jbossorg-tabzilla.js"></script>
    <script src="../../../../js/behavior.js"></script>
    <script src="../../../../js/prettify.js"></script>
    <script src="../../../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
