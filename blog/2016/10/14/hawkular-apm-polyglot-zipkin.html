<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Hawkular APM Distributed Tracing of Polyglot Application using Zipkin Instrumentations</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link href="../../../../css/tabzilla.css" rel="stylesheet">
    <link href="../../../../css/styles.css" rel="stylesheet">
    <link href="../../../../css/prettify.css" rel="stylesheet">
    <link href="../../../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../../../js/moment.min.js"></script>
    <script src="../../../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">
    <div id="wrap">
      <div class="dropup">
        <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
        <script>
            window.addEventListener('load', function() {
                 renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
        </script>
      </div>
	
    	<!-- Fixed navbar -->
        <nav class="navbar navbar-fixed-top" role="navigation">
          <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button class="navbar-toggle collapsed" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../../../../">Home</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav">
                <li><a href="../../../../overview/">Overview</a></li>
                <li><a href="../../../../blog.html">Blog</a></li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Services<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li class="menu-item dropdown dropdown-submenu">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../../hawkular-services/docs/quickstart-guide/">Quickstart</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../hawkular-services/docs/installation-guide/">Installation Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../hawkular-services/docs/user-guide/">User Guide</a>
                        </li>
                        <li class="menu-item dropdown dropdown-submenu">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">REST API</a>
                          <ul class="dropdown-menu">
                            <li class="menu-item ">
                              <a href="../../../../docs/rest/rest-alerts.html">Alerting</a>
                            </li>
                            <li class="menu-item ">
                              <a href="../../../../docs/rest/rest-inventory.html">Inventory</a>
                            </li>
                            <li class="menu-item ">
                              <a href="../../../../docs/rest/rest-metrics.html">Metrics</a>
                            </li>
                          </ul>
                        </li>
                      </ul>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-services/releases">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular APM<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                      <li><a href="../../../../hawkular-apm/">Overview</a></li>
                    </li>
                    <li>
                      <a href="https://hawkular.gitbooks.io/hawkular-apm-user-guide/content/">Documentation</a>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-apm/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Metrics<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../../hawkular-metrics/docs/user-guide/">User Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../docs/rest/rest-metrics.html">Metrics REST API</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../docs/rest/rest-alerts.html">Alerting REST API</a>
                        </li>
                      </ul>
                  </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-metrics/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li><a href="../../../../hawkular-clients/">Hawkular Clients</a></li>
                <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                  Community
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu">
                  <li>
                    <a href="../../../../community/docs/getting-involved/">Getting Involved</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../../../community/docs/developer-guide/">Developer Guide</a>
                  </li>
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../../community/labs/datamining/">Datamining</a>
                        </li>
                        <li class="menu-item ">
                          <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../hawkular-clients/android-client/">Android client</a>
                        </li>
                        <li class="menu-item ">
                          <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                        </li>
                      </ul>
                  </li>
                  <li>
                    <a href="https://github.com/hawkular">GitHub Repositories</a>
                  <li>
                    <a href="https://travis-ci.org/hawkular">CI Builds</a>
                  </li>
                </ul></li>
              </ul>
            </div>
          </div>
        </nav>

    <section class="main-banner blog-mainbanner">
        <div class="container">
            <h1>Hawkular APM Distributed Tracing of Polyglot Application using Zipkin Instrumentations</h1>
            <p>A blog post by Pavol Loffay</p>
            <p><strong>Tags:</strong> 
                           | <a href="/tags/APM.html">APM</a> 
                           | <a href="/tags/Zipkin.html">Zipkin</a> 
                           | <a href="/tags/polyglot.html">polyglot</a> 
                           | <a href="/tags/microservices.html">microservices</a> 
                           | <a href="/tags/distributed tracing.html">distributed tracing</a> 
             |</p>
            
        </div>
    </section>

    <div class="blog-container">
        <br/><br/>
    	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The latest focus of Hawkular APM has been in building a compatibility layer
for Zipkin instrumented applications. This enables Hawkular APM to leverage
Zipkin <a href="http://zipkin.io/pages/existing_instrumentations.html">instrumentation libraries</a>
and instrument polyglot applications.</p>
</div>
<div class="paragraph">
<p>In this blog post we will look how to use Zipkin instrumentation libraries to instrument
polyglot environment and how the reported data looks in Hawkular APM and Zipkin server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_polyglot_application">Polyglot Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A typical polyglot application consists of multiple services written in different programming
languages. These services interact together to fulfill some business needs or tasks.</p>
</div>
<div class="paragraph">
<p>The following image shows the architecture of our polyglot application.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/img/blog/2016/apm-zipkin-polyglot-arch.png" alt="apm zipkin polyglot arch">
</div>
<div class="title">Figure 1. Architecture of polyglot application</div>
</div>
<div class="paragraph">
<p>There are five applications written in 4 languages: Java, JavaScript, Python and Ruby.
It uses two databases MySQL and Apache Cassandra. Applications expose various REST endpoints
which simulate some behaviour. For example creating a user in a database or an asynchronous task.</p>
</div>
<div class="paragraph">
<p>Each application lives in a separate docker container. The whole environment can be deployed
using one line docker-compose command. Overall there are seven containers including Apache Kafka
to collect span data. The complete source code with instructions how to run it can be found on
<a href="https://github.com/hawkular/hawkular-apm/tree/master/examples/polyglot-zipkin">Github</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instrumentation_libraries">Instrumentation Libraries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are several <a href="http://zipkin.io/pages/existing_instrumentations.html">zipkin instrumentation libraries</a>.
Developers have to choose the relevant libraries for their target language (and framework).
If there is no instrumentation for a specific framework they have to report spans to the
server explicitly, thus having an instrumentation library for a popular web framework is a big
advantage (not limited to web).</p>
</div>
<div class="paragraph">
<p>In a typical microservice environment it is also necessary to add instrumentation for outgoing
requests so one application may use two or more Zipkin compliant instrumentation libraries.
These two implementations have to share trace context, and therefore proper initialization
is required.</p>
</div>
<div class="paragraph">
<p>Our applications are instrumented with following instrumentations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java (JAX-RS): <a href="https://github.com/openzipkin/brave">brave</a></p>
</li>
<li>
<p>Java Dropwizard (JAX-RS): <a href="https://github.com/smoketurner/dropwizard-zipkin">dropwizard-zipkin</a> uses brave</p>
</li>
<li>
<p>Apache Cassandra: <a href="https://github.com/thelastpickle/cassandra-zipkin-tracing">cassandra-zipkin-tracing</a> uses brave</p>
</li>
<li>
<p>JavaScript (express, cujoJS): <a href="https://github.com/openzipkin/zipkin-js">zipkin-js</a></p>
</li>
<li>
<p>Ruby (rack): <a href="https://github.com/openzipkin/zipkin-ruby">zipkin-ruby</a></p>
</li>
<li>
<p>Python (Pyramid): <a href="https://github.com/Yelp/pyramid_zipkin">pyramid_zipkin</a></p>
</li>
<li>
<p>Python (Bravado): <a href="https://github.com/Yelp/swagger_zipkin">swagger_zipkin</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These libraries are typically developed by a community and therefore reported data may differ. For
example a key of binary annotation representing HTTP URL can be <code>http.url</code> or <code>http.uri</code> or even
<code>http.path</code>. Some of the libraries do not report HTTP status code. Name of a span often represents
HTTP method but some instrumentations put there URL or even other data (cassandra-zipkin-tracing).
It is not an invalid behaviour, just keep in mind when querying data or exporting to external systems for
an analysis.</p>
</div>
<div class="paragraph">
<p>There are also a couple of
<a href="https://github.com/hawkular/hawkular-apm/tree/master/examples/polyglot-zipkin#known-issues">issues</a>
which can lead to an incorrect data presentation in Hawkular APM. Issues were also reported to the Zipkin project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_the_polyglot_application">Run the Polyglot Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Follow the instructions on
<a href="https://github.com/hawkular/hawkular-apm/tree/master/examples/polyglot-zipkin">Github</a>
to run the environment and start Hawkular APM server.</p>
</div>
<div class="paragraph">
<p>Execute following requests which we will analyze in the following sections.</p>
</div>
<div id="requests" class="listingblock">
<div class="title">Example HTTP requests</div>
<div class="content">
<pre>1. curl -ivX GET 'http://localhost:3001/nodejs/hello'
2. curl -ivX GET 'http://localhost:3000/dropwizard/A
3. curl -ivX GET 'http://localhost:3000/dropwizard/asyncTwoOutgoingCalls'
4. curl -ivX POST -H 'Content-Type: application/json' 'http://localhost:3001/nodejs/createUser' -d '{"name": "jdoe"}'</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_comparisons">Server Comparisons</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section compares user interfaces of Hawkular APM and Zipkin server.</p>
</div>
<div class="sect2">
<h3 id="_hawkular_apm_server">Hawkular APM Server</h3>
<div class="paragraph">
<p>In Hawkular APM user interface we are going to look at distributed tracing tab. If you run previous
commands there should be some data to analyze.</p>
</div>
<div class="paragraph">
<p>Following figure shows aggregated service interactions for selected initial endpoint (fourth request).
Nodes represent endpoint with URL and edges invocation flow.</p>
</div>
<div class="paragraph">
<p>Nodes holds statistics information like average, minimum and maximum duration,
total number of executions, service name and invoked URL.
Edges contain timing information of a network latency. This screen only shows nodes with a URL.
Databases and other components are shown in trace detail view.</p>
</div>
<div class="paragraph">
<p>For query capabilities we can specify time span, business transaction
(currently available only for java agent instrumentation and OpenTracing provider) and properties.
Properties represent binary annotations.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/img/blog/2016/apm-distributed-tracing-createUser.png" alt="apm distributed tracing createUser">
</div>
<div class="title">Figure 2. Hawkular APM Distributed Tracing</div>
</div>
<div class="paragraph">
<p>Next screen shows instance details. In other words a list of traces for the selected initial endpoint.
Table contains basic information as collected properties, start time, principal (for java agent instrumentation)
and overall trace duration. Details button opens a detailed graph.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/img/blog/2016/apm-instance-details.png" alt="apm instance details">
</div>
<div class="title">Figure 3. Hawkular APM Instance Details</div>
</div>
<div class="paragraph">
<p>In the detailed view users can see different types of nodes: producers (client span),
consumers (server span) and components (databases, EJBs). Tooltip is showing recorded binary annotations.
In this case it is a CQL query for storing an user into Apache Cassandra.</p>
</div>
<div class="paragraph">
<p>This concrete graph starts with a consumer (REST handler) and produces two producers (outgoing requests). These
requests are consumed by dropwizard and wildfly-swarm application and so on.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/img/blog/2016/apm-instance-details-createUser.png" alt="apm instance details createUser">
</div>
<div class="title">Figure 4. Hawkular APM Instance Details</div>
</div>
</div>
<div class="sect2">
<h3 id="_zipkin_server">Zipkin Server</h3>
<div class="paragraph">
<p>Let&#8217;s compare this now how the native Zipkin server shows stuff. Please start Zipkin server and
execute requests from <a href="#requests">Example HTTP requests</a>.</p>
</div>
<div class="paragraph">
<p>The first thing we are going to look at is a query capability. The user interface
offers to specify service name and names of recorded spans of a given service.
It is possible to specify span&#8217;s start time, end time and duration range.
For a more specific query it is possible to query on binary annotations,
which is helpful if we are looking for specific spans, for example HTTP URL of invoked service.
In the following figure it can be seen that we specified URL and HTTP status code
of invoked service.</p>
</div>
<div class="paragraph">
<p>The result of the query shows one trace which consist of 23 spans.
There is also a trace duration time and information which services were invoked within
that trace (also with a duration if possible to calculate).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/img/blog/2016/apm-zipkin-createUser-query.png" alt="apm zipkin createUser query">
</div>
<div class="title">Figure 5. Zipkin Query</div>
</div>
<div class="paragraph">
<p>The next screen is a trace instance view. It shows a timeline with timing data relative
to the trace start time. In the following figure there is a trace view for the third call.
It can be seen that it represent an asynchronous call. The first call ended before its
descendants.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/img/blog/2016/apm-zipkin-async.png" alt="apm zipkin async">
</div>
<div class="title">Figure 6. Zipkin Trace Detail</div>
</div>
<div class="paragraph">
<p>When you click on a specific span it shows a span detail view with events recorded within
the span. There are also recorded binary annotations which denotes information like HTTP URL
or HTTP status code. Instrumented application can add custom binary annotations.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/img/blog/2016/apm-zipkin-async-span-detail.png" alt="apm zipkin async span detail">
</div>
<div class="title">Figure 7. Zipkin Span Detail</div>
</div>
<div class="paragraph">
<p>The last Zipkin screen is showing dependencies between services. When you click on a specific
service it shows how many calls were triggered from a service to a service. The more calls to
the service the wider arrow.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/img/blog/2016/apm-zipkin-dependencies.png" alt="apm zipkin dependencies">
</div>
<div class="title">Figure 8. Zipkin Service Dependencies</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have seen a brief comparison of Hawkular APM and Zipkin server. Both of these projects
display data differently. Hawkular APM is doing more high level aggregations based on user
specific filter with calculation of statistics. On the other side Zipkin displays spans in
"RAW" fashion. There are definitely advantages and disadvantages for both of these approaches.</p>
</div>
<div class="paragraph">
<p>We are always interested to hear feedback from users on how the information presentation may be
improved to provide a powerful tool to analyze timing data of distributed applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_links">Links</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Polyglot example: <a href="https://github.com/hawkular/hawkular-apm/tree/master/examples/polyglot-zipkin" class="bare">https://github.com/hawkular/hawkular-apm/tree/master/examples/polyglot-zipkin</a></p>
</li>
<li>
<p>Zipkin instrumentations: <a href="http://zipkin.io/pages/existing_instrumentations.html" class="bare">http://zipkin.io/pages/existing_instrumentations.html</a></p>
</li>
<li>
<p>Hawkular APM: <a href="https://github.com/hawkular/hawkular-apm" class="bare">https://github.com/hawkular/hawkular-apm</a></p>
</li>
<li>
<p>Zipkin: <a href="https://github.com/openzipkin/zipkin" class="bare">https://github.com/openzipkin/zipkin</a></p>
</li>
</ul>
</div>
</div>
</div></p>
    	<hr /><br /><br />

        <p><em>Published by Pavol Loffay on  14 October 2016</em></p>

    <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'hawkular';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../../../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../../../js/jbossorg-tabzilla.js"></script>
    <script src="../../../../js/behavior.js"></script>
    <script src="../../../../js/prettify.js"></script>
    <script src="../../../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
