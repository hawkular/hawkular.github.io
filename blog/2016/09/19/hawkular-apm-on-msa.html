<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Using Hawkular APM on Red Hat&apos;s Microservices Reference Architecture example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link href="../../../../css/tabzilla.css" rel="stylesheet">
    <link href="../../../../css/styles.css" rel="stylesheet">
    <link href="../../../../css/prettify.css" rel="stylesheet">
    <link href="../../../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../../../js/moment.min.js"></script>
    <script src="../../../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">

	
<!-- Fixed navbar -->
<nav class="navbar navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <a class="navbar-brand" href="../../../..//">Home</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="../../../../blog.html" role="button">Blog</a></li>
        <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
          Community
          <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li class="menu-item">
              <a href="../../../../community/docs/getting-involved/">Getting Involved</a>
            </li>
            <li class="menu-item">
              <a href="../../../../community/docs/developer-guide/">Developer Guide</a>
            </li>
            <li class="menu-item dropdown dropdown-submenu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                <ul class="dropdown-menu">
                  <li class="menu-item ">
                    <a href="../../../../community/labs/datamining/">Datamining</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../../../hawkular-clients/android-client/">Android client</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                  </li>
                </ul>
            </li>
            <li>
              <a href="https://github.com/hawkular">GitHub Repositories</a>
            <li>
              <a href="https://travis-ci.org/hawkular">CI Builds</a>
            </li>
          </ul>
        </li>
      </ul>
      <div id="wrap">
        <div class="dropup">
          <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
          <script>
            window.addEventListener('load', function() {
              renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
          </script>
        </div>
      </div>
    </div>
</nav>

    <section class="main-banner blog-mainbanner">
        <div class="container">
            <h1>Using Hawkular APM on Red Hat&apos;s Microservices Reference Architecture example</h1>
            <p>A blog post by Juraci Paixão Kröhling</p>
<!-- show tags for this page -->
   <p> 
      <a href="/tags/apm.html">apm</a> 
          |
      <a href="/tags/microservice.html">microservice</a> 
  </p>
        </div>
    </section>

    <div class="blog-container">
        <br/><br/>
    	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The focus of the <a href="https://github.com/hawkular/hawkular-apm/releases/tag/0.10.0.Final">latest Hawkular APM release</a>
has been in building a compatibility layer for ZipKin-aware applications. In this blog post, we&#8217;ll show how Hawkular APM can
be used as a drop-in replacement for ZipKin server and UI.</p>
</div>
<div class="paragraph">
<p>A video demonstrating this approach can also be viewed <a href="https://www.youtube.com/watch?v=USyGYVYlDIM">here</a>.</p>
</div>
<div class="paragraph">
<p>At the end of this blog post, we should see data flowing from the target applications to Hawkular APM, without any code changes
to the application themselves:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-09-19-screenshot3.png" alt="Hawkular APM Dashboard">
</div>
</div>
<div class="paragraph">
<p>Red Hat offers a <a href="http://developers.redhat.com/products/cdk/overview/">Container Developer Toolkit</a>, or CDK, for its customers,
allowing for a quick start on developing applications following the best practices on the microservices architecture.</p>
</div>
<div class="paragraph">
<p>Along with the CDK, Red Hat publishes also a <a href="https://github.com/redhat-helloworld-msa">"MSA - Hello World Microservices Architecture"</a>,
which demonstrates how applications might benefit from this architecture. It can also be used as seed for your own
projects, as it shows how activities can be accomplished by using several technology stacks, from <code>nodejs/express</code> to <code>Wildfly Swarm</code>.</p>
</div>
<div class="paragraph">
<p>For Hawkular APM, this offers a great way to test our APIs on different stacks, specially our ZipKin compatibility layer. Ideally,
one would simply point the ZipKin URL setting to a Hawkular APM server and everything would just work.</p>
</div>
<div class="paragraph">
<p>And that&#8217;s what we are going to do in this post!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started_with_cdk_and_msa">Getting started with CDK and MSA</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_cdk_and_msa">CDK and MSA</h3>
<div class="paragraph">
<p>To setup CDK and MSA, we suggest that you follow the <a href="http://bit.ly/msainstructions">official instructions</a>. At the end of the process,
you should have all the services running. Open the "frontend" service, and click around a bit. For instance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Click on the "Browser as client" menu item, which will make the browser make Ajax calls directly to the API endpoints</p>
</li>
<li>
<p>Click on the "API Gateway" menu item: on this case, the browser makes a single call to the API Gateway, which in turn makes single API calls
to each of the services</p>
</li>
<li>
<p>Click on "Service chaining" menu item: on this case, each service calls the "next", adding the results to its own payload.</p>
</li>
<li>
<p>It could be interesting to make a note about the hostnames, to later make sure that you have "new" Docker containers running.
The default output for each of the services include the hostname. Concretely, the output <code>ola-7-9wa31</code> means that the service <code>ola</code> is
running on the container with hostname <code>9wa31</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Open the ZipKin interface, and make sure that data is arriving there. Check also the different visualizations for the different operations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hawkular_apm">Hawkular APM</h3>
<div class="paragraph">
<p>We&#8217;ll use the <a href="http://www.hawkular.org/blog/2016/07/14/hawkular-apm-openshift.html">previous post on running Hawkular APM on OpenShift</a>
as base to install our Hawkular APM alongside the other MSA examples. For this blog post, we&#8217;ll prepare our own image based on the official
Dockerfile for Hawkular APM. For that, fork and clone <a href="https://github.com/jboss-dockerfiles/hawkular">our repository</a> and run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cd hawkular-apm-server
oc new-app jboss/hawkular-apm-server
oc new-build --binary --name=hawkular-apm-server -l app=hawkular-apm-server
oc start-build hawkular-apm-server --from-dir=. --follow
oc expose service hawkular-apm-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the image from Docker Hub can be used, although it&#8217;s possible that networking issues might occur. If you use this option and
the build takes more than, say, 10 minutes to finish, do a <code>vagrant ssh</code> to enter the box, and check the logs via <code>journalctl -f</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">oc new-app jboss/hawkular-apm-server
oc expose service hawkular-apm-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should create a new image stream, build, deployment and application.</p>
</div>
<div class="paragraph">
<p>Before anything else, make note of the admin and password credentials. Those can be seen on the build logs:
Browse → Deployments → hawkular-apm-server → Click on the latest deployment → Logs.
A sample output is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>------------------------------------
ATTENTION ATTENTION ATTENTION ATTENTION
We automatically created an admin user for you to access the Hawkular APM web interface:
Username: adminQqyEF7i
Password: KS3mmZbkdhRZ5y7oF
------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once this is done, there should be a new service available on OpenShift&#8217;s dashboard, with an URL like <code><a href="http://hawkular-apm-server-helloworld-msa.rhel-cdk.10.1.2.2.xip.io" class="bare">http://hawkular-apm-server-helloworld-msa.rhel-cdk.10.1.2.2.xip.io</a></code>.</p>
</div>
<div class="paragraph">
<p>Now that everything is in place and working as expected, it&#8217;s time to switch from ZipKin to Hawkular APM!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_making_the_switch">Making the switch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each one of the MSA modules has a <code>Dockerfile</code>, specifying a <code>ENV ZIPKIN_SERVER_URL <a href="http://zipkin-query:9411" class="bare">http://zipkin-query:9411</a></code>.
From there, we have some options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change each <code>Dockerfile</code> to make the env var point to <code><a href="http://hawkular-apm-server:8080" class="bare">http://hawkular-apm-server:8080</a></code></p>
</li>
<li>
<p>Specify the <code>-e</code> option to Docker, to override the <code>ZIPKIN_SERVER_URL</code></p>
</li>
<li>
<p>Set an Environment Variable in the OpenShift deployment</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll choose the last option, as we consider that as the less invasive one, inline with the Microservice idea that configuration should not
be a concern for the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">oc env dc/aloha       ZIPKIN_SERVER_URL="http://hawkular-apm-server:8080"
oc env dc/api-gateway ZIPKIN_SERVER_URL="http://hawkular-apm-server:8080"
oc env dc/bonjour     ZIPKIN_SERVER_URL="http://hawkular-apm-server:8080"
oc env dc/hola        ZIPKIN_SERVER_URL="http://hawkular-apm-server:8080"
oc env dc/ola         ZIPKIN_SERVER_URL="http://hawkular-apm-server:8080"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait a bit until OpenShift finishes deploying the new containers, and hit "Refresh Results" on the frontend. Note that the hostnames will change, indicating
that a new container is running. At around the same time, you should see the first data flowing to Hawkular APM.</p>
</div>
<div class="paragraph">
<p><strong>Spoiler alert</strong>: after the first two screenshots that we added for orientation, we also included some screenshots with the final result.</p>
</div>
<div class="sect2">
<h3 id="_overriding_the_environment_variable_on_an_openshift_deployment">Overriding the environment variable on an OpenShift deployment:</h3>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-09-19-screenshot7.png" alt="Environment variable in OpenShift deployment">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hawkular_apm_deployment_logs_on_openshift">Hawkular APM Deployment logs on OpenShift:</h3>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-09-19-screenshot6.png" alt="Deployment log">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sample_of_the_aggregated_visualization_for_the_service_chaining_technique">Sample of the aggregated visualization for the "Service chaining" technique:</h3>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-09-19-screenshot1.png" alt="Service chaining">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_details_about_a_single_instance_of_the_service_chaining_technique">Details about a single instance of the "Service chaining" technique:</h3>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-09-19-screenshot5.png" alt="Screenshot 5">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sample_of_the_aggregated_visualization_for_the_api_gateway_technique">Sample of the aggregated visualization for the "API Gateway" technique:</h3>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-09-19-screenshot2.png" alt="API Gateway">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_details_about_a_single_instance_of_the_api_gateway_technique">Details about a single instance of the "API Gateway" technique:</h3>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-09-19-screenshot4.png" alt="Screenshot 4">
</div>
</div>
</div>
</div>
</div></p>
    	<hr /><br /><br />

        <p><em>Published by Juraci Paixão Kröhling on  19 September 2016</em></p>

    <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'hawkular';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../../../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../../../js/jbossorg-tabzilla.js"></script>
    <script src="../../../../js/behavior.js"></script>
    <script src="../../../../js/prettify.js"></script>
    <script src="../../../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
