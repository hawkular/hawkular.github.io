<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Metric Data Analysis using the Apache Spark</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link href="../../../../css/tabzilla.css" rel="stylesheet">
    <link href="../../../../css/styles.css" rel="stylesheet">
    <link href="../../../../css/prettify.css" rel="stylesheet">
    <link href="../../../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../../../js/moment.min.js"></script>
    <script src="../../../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">
    <div id="wrap">
      <div class="dropup">
        <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
        <script>
            window.addEventListener('load', function() {
                 renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
        </script>
      </div>
	
    	<!-- Fixed navbar -->
        <nav class="navbar navbar-fixed-top" role="navigation">
          <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button class="navbar-toggle collapsed" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../../../../">Home</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav">
                <li><a href="../../../../overview/">Overview</a></li>
                <li><a href="../../../../blog.html">Blog</a></li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Services<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li class="menu-item dropdown dropdown-submenu">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../../hawkular-services/docs/quickstart-guide/">Quickstart</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../hawkular-services/docs/installation-guide/">Installation Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../hawkular-services/docs/user-guide/">User Guide</a>
                        </li>
                        <li class="menu-item dropdown dropdown-submenu">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">REST API</a>
                          <ul class="dropdown-menu">
                            <li class="menu-item ">
                              <a href="../../../../docs/rest/rest-alerts.html">Alerting</a>
                            </li>
                            <li class="menu-item ">
                              <a href="../../../../docs/rest/rest-inventory.html">Inventory</a>
                            </li>
                            <li class="menu-item ">
                              <a href="../../../../docs/rest/rest-metrics.html">Metrics</a>
                            </li>
                          </ul>
                        </li>
                      </ul>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-services/releases">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular APM<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                      <li><a href="../../../../hawkular-apm/">Overview</a></li>
                    </li>
                    <li>
                      <a href="https://hawkular.gitbooks.io/hawkular-apm-user-guide/content/">Documentation</a>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-apm/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Metrics<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../../hawkular-metrics/docs/user-guide/">Metrics User Guide</a>
                        </li>
                        <li class="menu-item ">
                            <a href="../../../../community/docs/developer-guide/alerts.html">Alerting User Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../docs/rest/rest-metrics.html">Metrics REST API</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../docs/rest/rest-alerts.html">Alerting REST API</a>
                        </li>
                      </ul>
                  </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-metrics/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li><a href="../../../../hawkular-clients/">Hawkular Clients</a></li>
                <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                  Community
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu">
                  <li>
                    <a href="../../../../community/docs/getting-involved/">Getting Involved</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../../../community/docs/developer-guide/">Developer Guide</a>
                  </li>
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../../community/labs/datamining/">Datamining</a>
                        </li>
                        <li class="menu-item ">
                          <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../hawkular-clients/android-client/">Android client</a>
                        </li>
                        <li class="menu-item ">
                          <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                        </li>
                      </ul>
                  </li>
                  <li>
                    <a href="https://github.com/hawkular">GitHub Repositories</a>
                  <li>
                    <a href="https://travis-ci.org/hawkular">CI Builds</a>
                  </li>
                </ul></li>
              </ul>
            </div>
          </div>
        </nav>

    <section class="main-banner blog-mainbanner">
        <div class="container">
            <h1>Metric Data Analysis using the Apache Spark</h1>
            <p>A blog post by Jiri Kremser</p>
<!-- show tags for this page -->
   <p> 
      <a href="/tags/cassandra.html">cassandra</a> 
          |
      <a href="/tags/metrics.html">metrics</a> 
          |
      <a href="/tags/spark.html">spark</a> 
  </p>
        </div>
    </section>

    <div class="blog-container">
        <br/><br/>
    	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The goal of this blog post is to show how to easily connect <a href="https://spark.apache.org/">Apache Spark</a> to the
Cassandra with the metric data; perform simple transformation on the data as well as some examples of calculating correlation
between the two time series data streams. Last but not least we will show how to create a
<a href="https://en.wikipedia.org/wiki/K-means_clustering">k-means</a> clustering model.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-08-31-spark-logo.png" alt="Spark logo">
</div>
</div>
<div class="paragraph">
<p>The situation is visualized on the figure bellow. After the WildFly Agent was collecting the data for some time period and
reporting them to Hawkular Metrics. Hawkular Metrics stores them into Cassandra to which we will be connecting with Spark.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2016/2016-08-31-spark.png" alt="Components interaction">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initialization">Initialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we need to create a spark context with the <code>spark.cassandra.connection.host</code> property correctly set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-scala" data-lang="scala">val conf = new SparkConf()
  .setAppName("HelloHawkular")
  .setMaster("local")
  .set("spark.cassandra.connection.host", "127.0.0.1")
val sc = new SparkContext(conf)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is very simple, the only assumption here is that the <code>spark-cassandra-connector</code> jar is on the class path.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Apache Spark is completely written in Scala so also the examples are written in Scala.
Although, it provides also Java and Python APIs, using the language it has been written in is the best choice,
because one can track down the calls in the (native) source code.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reading_the_data_from_cassandra">Reading the data from Cassandra</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s create a "Resilient Distributed Dataset" (RDD) from Cassandra table called "data" in "hawkular_metrics" keyspace.
Resilient Distributed Datasets have <a href="https://spark.apache.org/docs/latest/api/scala/#org.apache.spark.rdd.RDD">plenty</a>
of useful operations defined. RDD is a leitmotif in Spark, all the data manipulation
is represented by chaining the operations on RDDs. It is an immutable structure that inherently supports parallelization.
Generally speaking, RDDs can be created as a result of calling a method on another RDD(s)
or by calling a method the <code>SparkContext</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-scala" data-lang="scala">val rdd: RDD[CassandraRow] = sc.cassandraTable("hawkular_metrics", "data")
println(rdd.count)
println(rdd.first)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This prints the number of rows (in my case 245609) and the very first row, just to have an idea how it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">CassandraRow{tenant_id: hawkular, type: 0, metric: MI~R~[e69a19f7-76e7-4fd2-8ed5-864d1570f3ff/Local~/deployment=hawkular-alerts-rest.war/subsystem=ejb3/singleton-bean=PartitionManagerImpl]~MT~Singleton EJB Metrics~Execution Time, dpart: 0, time: baef5a00-6e31-11e6-96d2-5f826fbc8eb1, aggregates: {}, availability: null, data_retention: null, l_value: null, n_value: 0.0, s_value: null, tags: {}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data table contains all the metrics so we need to filter only what we are interested in.
RDD provides a <code>groupBy</code> method that takes a function that is applied on all the data in the RDD and returns the key by
which the grouping should be done. We can group by the <code>metric</code>. This can be useful when working with more
metrics. But for our purposes, let&#8217;s just do simple filter method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-scala" data-lang="scala">val feedId = "e69a19f7-76e7-4fd2-8ed5-864d1570f3ff"
val metric1 = "Total Memory"
val metric2 = "Available Memory"
val total: RDD[Double] = rdd.filter(x =&gt; {
    val metricId = x.getString("metric")
    metricId.contains(feedId) &amp;&amp; metricId.contains(metric1)
  })
  .map(_.getDouble("n_value"))
  .repartition(8)

val free: RDD[Double] = rdd.filter(x =&gt; {
    val metricId = x.getString("metric")
    metricId.contains(feedId) &amp;&amp; metricId.contains(metric2)
  })
  .map(_.getDouble("n_value"))
  .repartition(8)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>repartition()</code> method needs to be called because methods like <code>filter</code>, <code>flatMap</code> and similar have impact on the
number of elements in each partition. We need those two RDDs to have the same amount of partitions and the same amount
of elements in each partition in order to be able to apply some statistical methods on them. Method called <code>coalesce</code>
is an alternative option to use here. Perhaps even better because it does not shuffle the data over the network in case
of multi node environment. However, the data model of Hawkular metrics ensures that data from one metric are always on
the same node.</p>
</div>
<div class="paragraph">
<p>Now, we have two RDDs. The <code>total</code> and <code>free</code> that represent the amounts of memory that was "free" on the platform and the total value.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_doing_something_fancy">Doing something fancy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let us create a derived RDD that will represent the used memory on the platform.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-scala" data-lang="scala">val used: RDD[Double] = total.zip(free).map(e =&gt; e._1 - e._2)</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we have done here is that we have created a new RDD, representing a metric data that were calculated using two
other metric streams. The transformation was trivial, but RDD provides also methods for aggregation.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s calculate the correlation between the used and free memory. There should be some correlation, right?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-scala" data-lang="scala">val correlation: Double = Statistics.corr(used, free, "pearson")
println(s"Correlation is: $correlation")</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will print <code>Correlation is: -0.9999999999999781</code>. That means there is total negative
<a href="https://en.wikipedia.org/wiki/Pearson_product-moment_correlation_coefficient">correlation</a> between the two
(the higher the first one, the lower the second one).
This example was artificial, but in general, one can calculate the correlation between any two metric streams. Of course,
correlation doesn&#8217;t imply causation, so we can&#8217;t extract any higher level information like business rules here.
But we obtain some information that metrics are somehow related together and with further analysis we can for example detect, that
change in one metric stream always precedes the change in the second metric stream. Again, it&#8217;s not causation, but something stronger than
correlation. <a href="https://en.wikipedia.org/wiki/Granger_causality">Granger causality test</a> is possible method,
nonetheless, this is out of the scope of this blog post.</p>
</div>
<div class="paragraph">
<p>Last thing, I wanted to show is the k-means clustering.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-scala" data-lang="scala">val usedMemoryVector = used.map(x =&gt; Vectors.dense(x))
val numClusters = 3
val numIterations = 20
val clusters: KMeansModel = KMeans.train(usedMemoryVector, numClusters, numIterations)
println("Cluster centers:")
clusters.clusterCenters.foreach(println)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above will print the three cluster representatives. It is also possible to test the new data point by
calling <code>clusters.predics(point)</code> that will return the expected cluster the point is attracted to.</p>
</div>
<div class="paragraph">
<p>There is <a href="https://spark.apache.org/docs/latest/mllib-guide.html">much more</a> in the MLlib. One can find outliers,
common patterns, do a classification, etc.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
All the code examples can be <a href="https://github.com/Jiri-Kremser/spark-hawkular-demo">downloaded</a> and run against the Cassandra with the metric data.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By using the <code>spark-cassandra-connector</code>, we were able to get the data from C* as RDD, call the simple operations on RDDs
and some smart functions from the MLlib package, but we entirely neglected the temporal aspect of the data. The only
reason it worked reasonably well is because the data is sorted in the table by the timestamp. There is a Spark library for
time series data out there called <a href="https://github.com/sryza/spark-timeseries">spark-ts</a>. Nice improvement would
be connecting the <code>spark-cassandra-connector</code> and <code>spark-ts</code> to provide convenient way of working with time series data
on top of Cassandra.</p>
</div>
<div class="paragraph">
<p>It is also worth mentioning that Spark does not offer only data processing on the data that was obtained by some "data pump".
Spark is so popular because it allows running the algorithms close to the data. In our case we had only single headed Cassandra,
but in general it can be run on a cluster consisting of multiple nodes. This, of course, requires the wisely chosen
partition keys in the schema respecting it when working with RDDs.</p>
</div>
</div>
</div></p>
    	<hr /><br /><br />

        <p><em>Published by Jiri Kremser on  31 August 2016</em></p>

    <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'hawkular';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../../../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../../../js/jbossorg-tabzilla.js"></script>
    <script src="../../../../js/behavior.js"></script>
    <script src="../../../../js/prettify.js"></script>
    <script src="../../../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
