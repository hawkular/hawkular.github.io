<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Testing collectd integration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/tabzilla.css" rel="stylesheet">
    <link href="../../css/styles.css" rel="stylesheet">
    <link href="../../css/prettify.css" rel="stylesheet">
    <link href="../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../js/moment.min.js"></script>
    <script src="../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">

	
<!-- Fixed navbar -->
<nav class="navbar navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <a class="navbar-brand" href="../..//">Home</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="../../blog.html" role="button">Blog</a></li>
        <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
          Community
          <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li class="menu-item">
              <a href="../../community/docs/getting-involved/">Getting Involved</a>
            </li>
            <li class="menu-item">
              <a href="../../community/docs/developer-guide/">Developer Guide</a>
            </li>
            <li class="menu-item dropdown dropdown-submenu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                <ul class="dropdown-menu">
                  <li class="menu-item ">
                    <a href="../../community/labs/datamining/">Datamining</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../hawkular-clients/android-client/">Android client</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                  </li>
                </ul>
            </li>
            <li>
              <a href="https://github.com/hawkular">GitHub Repositories</a>
            <li>
              <a href="https://travis-ci.org/hawkular">CI Builds</a>
            </li>
          </ul>
        </li>
      </ul>
      <div id="wrap">
        <div class="dropup">
          <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
          <script>
            window.addEventListener('load', function() {
              renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
          </script>
        </div>
      </div>
    </div>
</nav>

    <section class="main-banner blog-mainbanner">
        <div class="container">
            <h1>Testing collectd integration</h1>
            <p>A blog post by Thomas Segismont</p>
<!-- show tags for this page -->
   <p> 
      <a href="/tags/collectd.html">collectd</a> 
          |
      <a href="/tags/testing.html">testing</a> 
          |
      <a href="/tags/Travis.html">Travis</a> 
  </p>
        </div>
    </section>

    <div class="blog-container">
        <br/><br/>
    	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Hawkular Metrics is able to store data coming from <a href="http://collectd.org/" target="_blank">collectd</a>. To enable this
feature, you need to start the
<a href="https://github.com/hawkular/hawkular-metrics/tree/master/clients/ptranslator" target="_blank">ptrans</a> proxy, point it
to your Metrics server, and configure the collectd network plugin to send data to ptrans.</p>
</div>
<div id="img-stack" class="imageblock">
<div class="content">
<img src="../../img/blog/2015/collectd-ptrans-metrics.png" alt="collectd/ptrans/metrics stack">
</div>
<div class="title">Figure 1. collectd/ptrans/metrics stack</div>
</div>
<div class="paragraph">
<p><a href="https://commons.wikimedia.org/wiki/File:Logo_der_Software_collectd.svg#/media/File:Logo_der_Software_collectd.svg">
collectd logo by Florian Forster. Licensed under CC BY-SA 2.0 de via Wikimedia Commons</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="regression_test_requirements">Regression test requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To make sure the collectd/ptrans/Hawkular stack never gets broken, we wanted to have an integration test. This test
should fill the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>do not fail the build on machines where collectd is not available (non-Linux developers machines, or simply machines
where collectd is not installed)</p>
</li>
<li>
<p>run on Travis-CI, where each pull request is tested before being merged</p>
</li>
<li>
<p>make sure all data sent from collectd lands on the Hawkular Metrics server</p>
</li>
<li>
<p>run as quickly as possible</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s an outline of the implementation.</p>
</div>
<div class="sect2">
<h3 id="skip_test_when_collectd_is_not_available">Skip test when collectd is not available</h3>
<div class="paragraph">
<p><a href="https://github.com/junit-team/junit/wiki/Assumptions-with-assume" target="_blank">jUnit Assumptions</a> provide a nice way
to test the presence of external dependencies. The default jUnit runner will skip the test if the assumption fails. So
skipping the test when collectd is not available is just a matter of testing if the collectd binary exists, is a regular
file, and is executable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">private static final String COLLECTD_PATH = System.getProperty("collectd.path", "/usr/sbin/collectd");

// ...

@Before
public void setUp() throws Exception {
    // ...
    assumeCollectdIsPresent();
    // ...
}

private void assumeCollectdIsPresent() {
    Path path = Paths.get(COLLECTD_PATH);
    assumeTrue(COLLECTD_PATH + " does not exist", Files.exists(path));
    assumeTrue(COLLECTD_PATH + " is not a file", Files.isRegularFile(path));
    assumeTrue(COLLECTD_PATH + " is not executable", Files.isExecutable(path));
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run_on_travis_ci">Run on Travis-CI</h3>
<div class="paragraph">
<p><a href="http://docs.travis-ci.com/user/installing-dependencies/">
Travis lets you customize the virtual running the build</a>. Installing packages on the Ubuntu-based VM is very
straightforward, just add a couple of lines in the <code>before_install</code> target of your <code>.travis.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">before_install:
- sudo apt-get update -qq
- sudo apt-get install -qq collectd collectd-utils</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="verify_data_has_landed_on_the_metrics_server">Verify data has landed on the Metrics server</h3>
<div class="paragraph">
<p>collectd lets you configure one or more <em>write plugins</em>. The network plugin is required to send data to ptrans. We also
activate the csv plugin and make it log the measurements to <em>stdout</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-conf" data-lang="conf">LoadPlugin csv
&lt;Plugin csv&gt;
    DataDir stdout
&lt;/Plugin&gt;

LoadPlugin network
&lt;Plugin network&gt;
    Server "127.0.0.1" "25826"
    ReportStats false
&lt;/Plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we start collectd, preventing it to fork to the background with the <code>-f</code> option, and wait until a minimum number
of measurements has been sent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Test
public void shouldFindCollectdMetricsOnServer() throws Exception {

    // ...

    ImmutableList.Builder&lt;String&gt; collectdCmd = ImmutableList.builder();
    collectdCmd.add(COLLECTD_PATH, "-C", collectdConfFile.getAbsolutePath(), "-f");
    collectdProcessBuilder.command(collectdCmd.build());
    collectdProcess = collectdProcessBuilder.start();

    waitForCollectdValues();

    // ...

}

private void waitForCollectdValues() throws Exception {
    long c;
    do {
        Thread.sleep(MILLISECONDS.convert(1, SECONDS));
        c = Files.lines(collectdOut.toPath())
                 .filter(l -&gt; l.startsWith("PUTVAL"))
                 .collect(counting());
    } while (c &lt; MINIMUM);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When enough measurements have been collected and sent, all we need to do is to parse collectd <em>stdout</em> and compare with
server data, which can be loaded with an HTTP request.</p>
</div>
</div>
<div class="sect2">
<h3 id="run_as_quickly_as_possible">Run as quickly as possible</h3>
<div class="paragraph">
<p>At this point, all the ingredients can be combined to build an integration test. But the experience showed that running
it could take quite some time, even if the minimum number of measurements was low, and data collectd frequently (every
second).</p>
</div>
<div class="paragraph">
<p>A bit of investigation demonstrated that the test was spending an unexpected amount of time in  the
<code>waitForCollectdValues</code> method. It turned out that buffering of collectd output was the cause. To avoid it, we can use
the <code>stdbuf</code> tool from GNU <code>coreutils</code>: as explained in the manual page, it&#8217;s a tool to run a command "with modified
buffering operations for its standard streams".</p>
</div>
<div class="paragraph">
<p>With this slight modification, the test runs in a few seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">File stdbuf = new File("/usr/bin/stdbuf");
ImmutableList.Builder&lt;String&gt; collectdCmd = ImmutableList.builder();
if (stdbuf.exists() &amp;&amp; stdbuf.canExecute()) {
    collectdCmd.add(stdbuf.getAbsolutePath(), "-o0", "-e0");
}
collectdCmd.add(COLLECTD_PATH, "-C", collectdConfFile.getAbsolutePath(), "-f");
collectdProcessBuilder.command(collectdCmd.build());
collectdProcess = collectdProcessBuilder.start();</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it!</p>
</div>
</div>
</div>
</div></p>
    	<hr /><br /><br />

        <p><em>Published by Thomas Segismont on  08 April 2015</em></p>

    <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'hawkular';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../js/jbossorg-tabzilla.js"></script>
    <script src="../../js/behavior.js"></script>
    <script src="../../js/prettify.js"></script>
    <script src="../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
