<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Grafana: new query interface</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link href="../../../css/tabzilla.css" rel="stylesheet">
    <link href="../../../css/styles.css" rel="stylesheet">
    <link href="../../../css/prettify.css" rel="stylesheet">
    <link href="../../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../../js/moment.min.js"></script>
    <script src="../../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">

	
<!-- Fixed navbar -->
<nav class="navbar navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <a class="navbar-brand" href="../../..//">Home</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="../../../blog.html" role="button">Blog</a></li>
        <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
          Community
          <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li class="menu-item">
              <a href="../../../community/docs/getting-involved/">Getting Involved</a>
            </li>
            <li class="menu-item">
              <a href="../../../community/docs/developer-guide/">Developer Guide</a>
            </li>
            <li class="menu-item dropdown dropdown-submenu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                <ul class="dropdown-menu">
                  <li class="menu-item ">
                    <a href="../../../community/labs/datamining/">Datamining</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../../hawkular-clients/android-client/">Android client</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                  </li>
                </ul>
            </li>
            <li>
              <a href="https://github.com/hawkular">GitHub Repositories</a>
            <li>
              <a href="https://travis-ci.org/hawkular">CI Builds</a>
            </li>
          </ul>
        </li>
      </ul>
      <div id="wrap">
        <div class="dropup">
          <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
          <script>
            window.addEventListener('load', function() {
              renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
          </script>
        </div>
      </div>
    </div>
</nav>

    <section class="main-banner blog-mainbanner">
        <div class="container">
            <h1>Grafana: new query interface</h1>
            <p>A blog post by Joel Takvorian</p>
<!-- show tags for this page -->
   <p> 
      <a href="/tags/grafana.html">grafana</a> 
          |
      <a href="/tags/metrics.html">metrics</a> 
  </p>
        </div>
    </section>

    <div class="blog-container">
        <br/><br/>
    	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>There have been improvements lately in the Hawkular Grafana datasource that are worth mentioning.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The way to query metrics by tags has changed since plugin <a href="https://github.com/hawkular/hawkular-grafana-datasource/releases/tag/v1.0.8">v1.0.8</a>.
It now takes advantage of the Hawkular Metrics' tags query language,
that was introduced server-side in <a href="http://www.hawkular.org/blog/2017/02/08/hawkular-metrics-0.24.0.Final-released.html">Metrics 0.24.0</a>
and enhanced in <a href="http://www.hawkular.org/blog/2017/03/07/hawkular-metrics-0.25.0.Final-released.html">0.25.0</a>.
To sum it up, Metrics integrates a parser that allows queries such as:
<code>tag1 = 'awesome!' AND tag2 NOT IN ['foo', 'bar']</code>.</p>
</li>
<li>
<p>The datasource in now able to fetch bucketized metrics stats, instead of raw metrics.
It consists in aggregating datapoints in slices of time (buckets) and providing, for each slice, some statistics like <em>min</em>, <em>max</em>, <em>average</em> and more.
The exact content of a bucket is described in <a href="http://www.hawkular.org/docs/rest/rest-metrics.html#NumericBucketPoint">Metrics REST API</a>.
Hawkular has always been able to provide metric stats server-side,
but being able to use them in the Grafana plugin is new, introduced in <a href="https://github.com/hawkular/hawkular-grafana-datasource/releases/tag/v1.0.9">v1.0.9</a>.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/blog/2017/2017-07-20-grafana-empty-query.png" alt="New query interface">
</div>
</div>
<div class="paragraph text-center">
<p><em>The new query interface</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tags_query_language">Tags query language</h3>
<div class="paragraph">
<p>The first change is that you don&#8217;t have to choose between <em>query by tag</em> and <em>query by metric id</em> anymore, you can do both at the same time.
Querying by tag will refine the available list of metric names (much like a filter) and can result in multiple metrics from a single query.
By selecting a <em>metric name</em>, you restrict the query to only display that one.
This filtering is really nice when there&#8217;s tons of metrics available, like in the case of
hundreds of OpenShift pods being monitored with the same tenant.</p>
</div>
<div class="paragraph">
<p>The simple <em>key/value</em> pairs interface is now replaced with a more elaborated query builder, following the pattern:
<em>'tag-key'</em> <em>'operator'</em> <em>'tag-value(s)'</em> [<em>'AND/OR'</em> etc.]</p>
</div>
<div class="paragraph">
<p>The following images show a walk-through:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/blog/2017/2017-07-20-grafana-tag_key.png" alt="Selecting tag key">
</div>
</div>
<div class="paragraph text-center">
<p><em>Selecting the tag key</em></p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/blog/2017/2017-07-20-grafana-tag_operator.png" alt="Selecting tag operator">
</div>
</div>
<div class="paragraph text-center">
<p><em>Selecting the tag operator</em></p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/blog/2017/2017-07-20-grafana-tag_value.png" alt="Selecting tag value">
</div>
</div>
<div class="paragraph text-center">
<p><em>Selecting the tag value</em></p>
</div>
<div class="paragraph">
<p>The text fields include dynamic suggestions, you can use Grafana template variables within tag values, or enter free text.
Once you&#8217;ve set up a tag query expression, the relevant metrics immediately show up on the chart and the list of available metrics in the dropdown list in updated.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/blog/2017/2017-07-20-grafana-tag-filtering.png" alt="Filtered metrics">
</div>
</div>
<div class="paragraph text-center">
<p><em>Filtered metrics</em></p>
</div>
<div class="paragraph">
<p>This query builder lets you build almost any tag query that the Hawkular server understands.
There are however some corner cases. For now this builder doesn&#8217;t allow you to prioritize expressions with parentheses.
For instance, you cannot build <code>c1 = 'foo' OR (b1 != 'B' AND a1 = 'abcd')</code>.
As a workaround you can turn off the query builder and directly type in your query expression.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/blog/2017/2017-07-20-grafana-editor-mode.png" alt="Toggle editor mode">
</div>
</div>
<div class="paragraph text-center">
<p><em>Toggle editor mode</em></p>
</div>
<div class="paragraph">
<p>It will be sent as is to the Hawkular Metrics server.
This will also be useful to fill the gap if the language evolves server-side and this plugin isn&#8217;t updated immediately.</p>
</div>
</div>
<div class="sect2">
<h3 id="_stats_query">Stats query</h3>
<div class="paragraph">
<p>The other important feature is the ability to run <a href="http://www.hawkular.org/hawkular-metrics/docs/user-guide/#_downsampling">stats</a> queries against Hawkular Metrics, instead of <a href="http://www.hawkular.org/hawkular-metrics/docs/user-guide/#_raw_data">raw</a> queries.
There are several reasons to do this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it reduces the network load, and client-side processing load, especially when raw data would contain tons of datapoints</p>
</li>
<li>
<p>it enables some aggregation methods</p>
</li>
<li>
<p>it also allows higher-level analysis with stats such as percentiles</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To enable it, just clear the <em>raw</em> checkbox.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/blog/2017/2017-07-20-grafana-stats-mode.png" alt="Toggle stats mode">
</div>
</div>
<div class="paragraph text-center">
<p><em>Toggle stats mode</em></p>
</div>
<div class="paragraph">
<p>When you clear the <em>raw</em> checkbox, you can configure <em>Multiple series aggregation</em> to <em>None</em>, <em>Sum</em> or <em>Average</em>
and can configure <em>Stat type</em> as <em>avg</em>, <em>min</em>, <em>max</em>, <em>median</em>, <em>sum</em> and different percentiles.
You can display several different <em>Stat types</em> within the same query.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/blog/2017/2017-07-20-grafana-stats-none.png" alt="Stats without aggregation">
</div>
</div>
<div class="paragraph text-center">
<p><em>Stats without aggregation: each two metrics show avg, min and max</em></p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/img/blog/2017/2017-07-20-grafana-stats-avg.png" alt="Stats avg">
</div>
</div>
<div class="paragraph text-center">
<p><em>Same query with series aggregation: the two metrics are averaged into one, which shows avg, min and max</em></p>
</div>
<div class="paragraph">
<p>If the query returns multiple series, use <em>Multiple series aggregation</em> to define if and how to aggregate them.
<em>None</em> will show them individually on the chart. But consider for instance the case of an OpenShift pod with many replicas, and you&#8217;re tracking their memory usage.
It may be more relevant here to aggregate all of them, both <em>sum</em> and <em>average</em> are meaningful here.</p>
</div>
<div class="paragraph">
<p>The <em>Stat type</em> option refers to an aggregation at a different level: not between multiple metrics, but within a single metric,
all raw datapoints are aggregated within time buckets.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>These two improvements aim a common goal, that is facilitating querying over large amounts of data. This is becoming crucial especially
in the context of microservices and applications running on container platforms, as the number of metrics explodes.
Proper metrics tagging is the corner stone to make sense of this data.</p>
</div>
</div></p>
    	<hr /><br /><br />

        <p><em>Published by Joel Takvorian on  24 July 2017</em></p>

    <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'hawkular';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../../js/jbossorg-tabzilla.js"></script>
    <script src="../../../js/behavior.js"></script>
    <script src="../../../js/prettify.js"></script>
    <script src="../../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
