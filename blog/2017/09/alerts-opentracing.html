<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Hawkular Alerts with OpenTracing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link href="../../../css/tabzilla.css" rel="stylesheet">
    <link href="../../../css/styles.css" rel="stylesheet">
    <link href="../../../css/prettify.css" rel="stylesheet">
    <link href="../../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../../js/moment.min.js"></script>
    <script src="../../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">

	
<!-- Fixed navbar -->
<nav class="navbar navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <a class="navbar-brand" href="../../..//">Home</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="../../../blog.html" role="button">Blog</a></li>
        <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
          Community
          <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li class="menu-item">
              <a href="../../../community/docs/getting-involved/">Getting Involved</a>
            </li>
            <li class="menu-item">
              <a href="../../../community/docs/developer-guide/">Developer Guide</a>
            </li>
            <li class="menu-item dropdown dropdown-submenu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                <ul class="dropdown-menu">
                  <li class="menu-item ">
                    <a href="../../../community/labs/datamining/">Datamining</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../../hawkular-clients/android-client/">Android client</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                  </li>
                </ul>
            </li>
            <li>
              <a href="https://github.com/hawkular">GitHub Repositories</a>
            <li>
              <a href="https://travis-ci.org/hawkular">CI Builds</a>
            </li>
          </ul>
        </li>
      </ul>
      <div id="wrap">
        <div class="dropup">
          <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
          <script>
            window.addEventListener('load', function() {
              renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
          </script>
        </div>
      </div>
    </div>
</nav>

    <section class="main-banner blog-mainbanner">
        <div class="container">
            <h1>Hawkular Alerts with OpenTracing</h1>
            <p>A blog post by John Mazzitelli</p>
<!-- show tags for this page -->
   <p> 
      <a href="/tags/alerts.html">alerts</a> 
          |
      <a href="/tags/jaeger.html">jaeger</a> 
          |
      <a href="/tags/opentracing.html">opentracing</a> 
  </p>
        </div>
    </section>

    <div class="blog-container">
        <br/><br/>
    	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Two recent blogs discuss how OpenTracing instrumentation can be used to collect application metrics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.hawkular.org/blog/2017/06/26/opentracing-appmetrics.html" class="bare">http://www.hawkular.org/blog/2017/06/26/opentracing-appmetrics.html</a></p>
</li>
<li>
<p><a href="http://www.hawkular.org/blog/2017/08/opentracing-appmetrics-canary.html" class="bare">http://www.hawkular.org/blog/2017/08/opentracing-appmetrics-canary.html</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A further interesting integration can be the addition of Hawkular Alerts to the environment.</p>
</div>
<div class="paragraph">
<p>As the previous <a href="http://www.hawkular.org/blog/2017/08/alerts-multiple-sources.html">blog</a> and <a href="https://www.youtube.com/watch?v=mM1mwJneKO4">demo</a> discuss, Hawkular Alerts is a generic, federated alerts system that can trigger events, alerts, and notifications from different, independent systems such as Prometheus, ElasticSearch, and Kafka.</p>
</div>
<div class="paragraph">
<p>Here we can combine the two. Let&#8217;s follow the directions for the OpenTracing demo (using the Jaeger implementation) and add Hawkular Alerts.</p>
</div>
<div class="paragraph">
<p>What this can show is OpenTracing application metrics triggering alerts when (as in this example) OpenTracing spans encounter a larger-than-expected error rates.</p>
</div>
<div class="paragraph">
<p>(Note: these instructions assume you are using Kubernetes / Minikube - see the Hawkular OpenTracing blogs linked above for more details on these instructions)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_start_kubernetes">START KUBERNETES</h3>
<div class="paragraph">
<p>Here we start minikube giving it enough resources to run all of the pods necessary for this demo. We also start up a browser pointing to the Kubernetes dashboard, so you can follow the progress of the remaining instructions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>minikube start --cpus 4 --memory 8192

minikube dashboard</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_prometheus">DEPLOY PROMETHEUS</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>kubectl create -f https://raw.githubusercontent.com/coreos/prometheus-operator/v0.11.0/bundle.yaml

kubectl create -f https://raw.githubusercontent.com/objectiser/opentracing-prometheus-example/master/prometheus-kubernetes.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Note: the last command might not work depending on your version - if you get errors, download a copy of prometheus-kubernetes.yml and edit it, changing “v1alpha1” to “v1”)</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_jaeger">DEPLOY JAEGER</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>kubectl create -f https://raw.githubusercontent.com/jaegertracing/jaeger-kubernetes/master/all-in-one/jaeger-all-in-one-template.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following will build and deploy the Jaeger example code that will produce the OpenTracing data for the demo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>mkdir -p ${HOME}/opentracing ; cd ${HOME}/opentracing

git clone git@github.com:objectiser/opentracing-prometheus-example.git

cd opentracing-prometheus-example/simple

eval $(minikube docker-env)

mvn clean install docker:build

kubectl create -f services-kubernetes.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Note: The last command might not work depending on your version - if you get errors, edit services-kubernetes.yml, changing “v1alpha1” to “v1”)</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_hawkular_alerts_and_create_alert_trigger">DEPLOY HAWKULAR-ALERTS AND CREATE ALERT TRIGGER</h3>
<div class="paragraph">
<p>The following will deploy Hawkular Alerts and create the trigger definition that will trigger an alert when the Jaeger OpenTracing data indicates an error rate that is over 30%</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>kubectl create -f https://raw.githubusercontent.com/hawkular/hawkular-alerts/master/dist/hawkular-alerts-k8s.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next use <code>minikube service hawkular-alerts --url</code> to determine the Hawkular Alerts URL and point your browser to the path “/hawkular/alerts/ui” at that URL (i.e. <code><a href="http://host:port/hawkular/alerts/ui" class="bare">http://host:port/hawkular/alerts/ui</a></code>).</p>
</div>
<div class="paragraph">
<p>From the browser page running the Hawkular Alerts UI, enter a tenant name in the top right text field (“my-organization” for example) and click the “Change” button.</p>
</div>
<div class="paragraph">
<p>Navigate to the “Triggers” page (found in the left-hand nav menu).</p>
</div>
<div class="paragraph">
<p>Click the kabob menu icon at the top and select “New Trigger”.</p>
</div>
<div class="paragraph">
<p>In the text area, enter the following to define a new trigger that will trigger alerts when the Prometheus query shows that there is a 30% error rate or greater in the accountmgr or ordermgr servers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
   "trigger":{
      "id":"jaeger-prom-trigger",
      "name":"High Error Rate",
      "description":"Data indicates high error rate",
      "severity":"HIGH",
      "enabled":true,
      "autoDisable":false,
      "tags":{
         "prometheus":"Test"
      },
      "context":{
         "prometheus.url":"http://prometheus:9090"
      }
   },
   "conditions":[
      {
         "type":"EXTERNAL",
         "alerterId":"prometheus",
         "dataId":"prometheus-test",
         "expression":"(sum(increase(span_count{error=\"true\",span_kind=\"server\"}[1m])) without (pod,instance,job,namespace,endpoint,transaction,error,operation,span_kind) / sum(increase(span_count{span_kind=\"server\"}[1m])) without (pod,instance,job,namespace,endpoint,transaction,error,operation,span_kind)) &gt; 0.3"
      }
   ]
}</code></pre>
</div>
</div>
<hr>
<div id="new-trigger" class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-09-06-new-trigger.png" alt="2017 09 06 new trigger">
</div>
<div class="title">Figure 1: Create New Alert Trigger</div>
</div>
<div id="trigger" class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-09-06-trigger.png" alt="2017 09 06 trigger">
</div>
<div class="title">Figure 2: Alert Trigger</div>
</div>
<hr>
<div class="paragraph">
<p>Now navigate back to the “Dashboard” page (again via the left-hand nav menu). From this Dashboard page, look for alerts when they are triggered. We&#8217;ll next start generating the data that will trigger these alerts.</p>
</div>
</div>
<div class="sect2">
<h3 id="_generate_some_sample_open_tracing_application_data">GENERATE SOME SAMPLE OPEN TRACING APPLICATION DATA</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>export ORDERMGR=$(minikube service ordermgr --url)

${HOME}/opentracing/opentracing-prometheus-example/simple/genorders.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the data starts to be collected, you will see alerts in the Hawkular Alerts UI as error rates become over 30% in the past minute (as per the Prometheus query).</p>
</div>
<hr>
<div id="dashboard" class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-09-06-dashboard.png" alt="2017 09 06 dashboard">
</div>
<div class="title">Figure 3: Alerts Dashboard</div>
</div>
<div id="alert-list" class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-09-06-alert-list.png" alt="2017 09 06 alert list">
</div>
<div class="title">Figure 4: Alert</div>
</div>
<hr>
<div class="paragraph">
<p>If you look at the alerts information in the Hawkular Alerts UI, you’ll see the conditions that triggered the alerts. For example, one such alert could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Time: 2017-09-01 17:41:17 -0400
External[prometheus]: prometheus-test[Event [tenantId=my-organization,
id=1a81471d-340d-4dba-abe9-5b991326dc80, ctime=1504302077288, category=prometheus,
dataId=prometheus-test, dataSource=<em>none</em>, text=[1.504302077286E9, <strong>0.3333333333333333</strong>],
context={<strong>service=ordermgr</strong>, version=<strong>0.0.1</strong>}, tags={}, trigger=null]] matches
[(sum(increase(span_count{error="true",span_kind="server"}[1m])) without
(pod,instance,job,namespace,endpoint,transaction,error,operation,span_kind) /
sum(increase(span_count{span_kind="server"}[1m])) without
(pod,instance,job,namespace,endpoint,transaction,error,operation,span_kind)) &gt; 0.3]</pre>
</div>
</div>
<div class="paragraph">
<p>Notice the “<strong>ordermgr</strong>” service (version "<strong>0.0.1</strong>") had an error rate of <strong>0.3333</strong> (33%) which caused the alert since it is above the allowed 30% threshold.</p>
</div>
<div class="paragraph">
<p>At this point, the Hawkular Alerts UI provides the ability for system admins to log notes about the issue, acknowledge the alert and mark the alert resolved if the underlying issue has been fixed. These lifecycle functions (also available as REST operations) are just part of the value add of Hawkular-Alerts.</p>
</div>
<div class="paragraph">
<p>You could do more complex things such as only trigger this alert if this Prometheus query generated results AND some other condition was true (say, ElasticSearch logs match a particular pattern, or if a Kafka topic had certain data). This demo merely scratches the surface, but does show how Hawkular Alerts can be used to work with OpenTracing to provide additional capabilities that may be found useful by system administrators and IT support personnel.</p>
</div>
</div></p>
    	<hr /><br /><br />

        <p><em>Published by John Mazzitelli on  06 September 2017</em></p>

    <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'hawkular';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../../js/jbossorg-tabzilla.js"></script>
    <script src="../../../js/behavior.js"></script>
    <script src="../../../js/prettify.js"></script>
    <script src="../../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
