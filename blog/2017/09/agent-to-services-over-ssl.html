<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Connecting Hawkular Agent to Hawkular Services over SSL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link href="../../../css/tabzilla.css" rel="stylesheet">
    <link href="../../../css/styles.css" rel="stylesheet">
    <link href="../../../css/prettify.css" rel="stylesheet">
    <link href="../../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../../js/moment.min.js"></script>
    <script src="../../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">

	
<!-- Fixed navbar -->
<nav class="navbar navbar-fixed-top" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <a class="navbar-brand" href="../../..//">Home</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="../../../blog.html" role="button">Blog</a></li>
        <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
          Community
          <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li class="menu-item">
              <a href="../../../community/docs/getting-involved/">Getting Involved</a>
            </li>
            <li class="menu-item">
              <a href="../../../community/docs/developer-guide/">Developer Guide</a>
            </li>
            <li class="menu-item dropdown dropdown-submenu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                <ul class="dropdown-menu">
                  <li class="menu-item ">
                    <a href="../../../community/labs/datamining/">Datamining</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../../hawkular-clients/android-client/">Android client</a>
                  </li>
                  <li class="menu-item ">
                    <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                  </li>
                </ul>
            </li>
            <li>
              <a href="https://github.com/hawkular">GitHub Repositories</a>
            <li>
              <a href="https://travis-ci.org/hawkular">CI Builds</a>
            </li>
          </ul>
        </li>
      </ul>
      <div id="wrap">
        <div class="dropup">
          <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
          <script>
            window.addEventListener('load', function() {
              renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
          </script>
        </div>
      </div>
    </div>
</nav>

    <section class="main-banner blog-mainbanner">
        <div class="container">
            <h1>Connecting Hawkular Agent to Hawkular Services over SSL</h1>
            <p>A blog post by Josejulio Martínez</p>
<!-- show tags for this page -->
   <p> 
      <a href="/tags/services.html">services</a> 
          |
      <a href="/tags/ssl.html">ssl</a> 
  </p>
        </div>
    </section>

    <div class="blog-container">
        <br/><br/>
    	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>SSL provides identification of the communicating parties, confidentiality and integrity of the information being shared.</p>
</div>
<div class="paragraph">
<p>In production environments, network eavesdropping could be a concern. You can use SSL to provide a secure communication
channel between servers.</p>
</div>
<div class="paragraph">
<p>Hawkular Services expects Hawkular Agents to connect, push information and listen for commands.
These commands also include server credentials that could be vulnerable to a man-in-the-middle attack.</p>
</div>
<div class="paragraph">
<p>A previous <a href="http://www.hawkular.org/hawkular-services/docs/installation-guide/secure-comm.html">article</a> shows how
to configure your Hawkular Services with SSL and have Hawkular Agents connect to it trough SSL.
This guide will show how is done for Dockerized Hawkular Services Agents.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preparing_your_certificates">Preparing your certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before starting we need to prepare the certificates that we are going to use.
Your public and private key for Hawkular Services need to be on PEM or PKC12 format.
For this guide we will use PEM.</p>
</div>
<div class="paragraph">
<p>We can create self-signed certificates (in PEM format) using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>keytool -genkey -keystore hawkular.keystore -alias hawkular -dname "CN=hawkular-services" -keyalg RSA -storepass hawkular -keypass hawkular -validity 36500 -ext san=ip:127.0.0.1,dns:hawkular-services
keytool -importkeystore -srckeystore hawkular.keystore  -destkeystore hawkular.p12 -deststoretype PKCS12 -srcalias hawkular -deststorepass hawkular -destkeypass hawkular -srcstorepass hawkular
openssl pkcs12 -in hawkular.p12 -password pass:hawkular -nokeys -out hawkular-services-public.pem
openssl pkcs12 -in hawkular.p12 -password pass:hawkular -nodes -nocerts -out hawkular-services-private.key</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When creating the certificates, remember to include the host that Hawkular will use
(as Common Name(CN) and Subject Alternative Name(SAN)), else the certificate validation will fail.
Through this guide, host will be set to hawkular-services.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Always include san=ip:127.0.0.1 in your certificate, as this will be used internally by Hawkular Services.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_starting_cassandra">Starting Cassandra</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hawkular Services requires a cassandra instance, you can start one by doing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>docker run --name hawkular-cassandra -e CASSANDRA_START_RPC=true -d cassandra:3.0.12</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_starting_hawkular_services_on_ssl">Starting Hawkular Services on SSL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that there is a cassandra ready, Hawkular Services can be started,
it will be linked to the cassandra instance (hawkular-cassandra)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>docker pull hawkular/hawkular-services
docker run --name hawkular-services --link=hawkular-cassandra -e CASSANDRA_NODES=hawkular-cassandra -e HAWKULAR_HOSTNAME=hawkular-services -e HAWKULAR_USE_SSL=true -p 8443:8443 -v `pwd`/hawkular-services-private.key:/client-secrets/hawkular-services-private.key:z -v `pwd`/hawkular-services-public.pem:/client-secrets/hawkular-services-public.pem:z hawkular/hawkular-services</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To avoid guessing the host, we explicitly set it to hawkular-services
using HAWKULAR_HOSTNAME environmental variable.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you don&#8217;t specify any certificate, Hawkular services will create one,
but we won&#8217;t be able to connect agents unless we export the certificate.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_starting_a_hawkular_agent">Starting a Hawkular Agent</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By now there should be a Hawkular Services listening on default secure port 8443, if any agent wants to connect,
it will need to know and trust its certificate.
If you are self-signing your certificate, you will need to pass Hawkular Service&#8217;s certificate when starting the agent.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>docker pull hawkular/wildfly-hawkular-javaagent
docker run --name hawkular-agent-01 --link=hawkular-services -e HAWKULAR_SERVER_PROTOCOL=https -e HAWKULAR_SERVER_ADDR=hawkular-services -e HAWKULAR_SERVER_PORT=8443 -v `pwd`/hawkular-services-public.pem:/client-secrets/hawkular-services-public.pem:z hawkular/wildfly-hawkular-javaagent</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Host must match with the one specified in the certificate, thus setting HAWKULAR_SERVER_ADDR to hawkular-services
is required. Update as needed if using other value.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_the_setup">Testing the setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Any Hawkular client that supports connecting using SSL can be used. Curl, ManageIQ and HawkFX will be show below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If using self-signed certificates, the client machine needs to trust Hawkular Services certificate or the client
should support to specify which certificate to trust.
See <a href="http://www.hawkular.org/blog/2016/09/14/consuming-hawkular-api-over-ssl.html">here</a>
for more info.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_curl">Curl</h3>
<div class="paragraph">
<p>Simplest way to test, we only need to tell curl how to resolve <code>hawkular-services</code> and pass the public certificate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>curl -H "Hawkular-Tenant: hawkular" --resolve "hawkular-services:8443:127.0.0.1" --cacert hawkular-services-prd -X GET https://hawkular-services:8443/hawkular/metrics/metrics</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will output metrics stored on Hawkular Services.</p>
</div>
</div>
<div class="sect2">
<h3 id="_manageiq">ManageIQ</h3>
<div class="paragraph">
<p>It can be quickly tested using the dockerized ManageIQ as follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>docker run --link=hawkular-services --privileged -d -p 8444:443 manageiq/manageiq:fine-3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once ManageIQ has started, add a Middleware Provider, there is three secured ways to do that:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>SSL &#8201;&#8212;&#8201;Requires that the client box trusts Hawkular Services certificate.</p>
</li>
<li>
<p>SSL trusting custom CA&#8201;&#8212;&#8201;Requires to provide the certificate to trust.</p>
</li>
<li>
<p>SSL without validation&#8201;&#8212;&#8201;No validation is performed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We will focus on (2) and (3) as (1) will require to trust the certificates on the machine itself.</p>
</div>
<div class="paragraph">
<p>Before going onto details, navigate to <code><a href="https://localhost:8444/" class="bare">https://localhost:8444/</a></code>,
login with default username <code>admin</code> and password <code>smartvm</code>.
Click on Middleware &#8594; Configuration &#8594; Add a New Middleware Provider.</p>
</div>
<div class="sect3">
<h4 id="_ssl_trusting_custom_ca">SSL trusting custom CA</h4>
<div class="paragraph">
<p>We need to select <code>SSL trusting custom CA</code> in <code>Security Protocol</code>
and copy the certificate from the contents of <code>hawkular-services-public.pem</code>.
Fill the Hostname with the one used in the certificate and complete the required information.</p>
</div>
<div id="mw-ssl-trusting-custom-ca" class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-09-manageiq-custom-ca.png" alt="2017 09 manageiq custom ca">
</div>
<div class="title">Figure 1: Middleware Provider SSL trusting custom ca</div>
</div>
</div>
<div class="sect3">
<h4 id="_ssl_without_validation">SSL without validation</h4>
<div class="paragraph">
<p>We need to select <code>SSL without validation</code> in <code>Security Protocol</code>.
No validation regarding the certificate is made with this option, only fill the required information.</p>
</div>
<div id="mw-ssl-without-validation" class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-09-manageiq-custom-ca.png" alt="2017 09 manageiq custom ca">
</div>
<div class="title">Figure 2: Middleware Provider SSL without validation</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hawkfx">HawkFX</h3>
<div class="paragraph">
<p>One can connect using <a href="http://www.hawkular.org/blog/2016/07/13/hawkfx.html">HawkFx</a>
by either installing the certificate on the machine or disabling the verification as
show in the image.
You will also need to update your <code>/etc/hosts</code> to resolve <code>hawkular-services</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>sudo su -c "echo '127.0.0.1 hawkular-services' &gt;&gt; /etc/hosts"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if no verification is used, one could use <code>localhost</code> instead of <code>hawkular-services</code>.</p>
</div>
<div id="hawkfx-disable-validation" class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-09-hawkfx-disable-validation.png" alt="2017 09 hawkfx disable validation">
</div>
<div class="title">Figure 3: HawkFX without validation</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Securing communications between a dockerized Hawkular Agent and Hawkular Services is possible with
self-signed certificates. Connecting clients is also possible with the additional step of providing the certificate.</p>
</div>
</div>
</div></p>
    	<hr /><br /><br />

        <p><em>Published by Josejulio Martínez on  19 September 2017</em></p>

    <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'hawkular';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../../js/jbossorg-tabzilla.js"></script>
    <script src="../../../js/behavior.js"></script>
    <script src="../../../js/prettify.js"></script>
    <script src="../../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
