<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - Adjusting sampling rates for Hawkular APM on OpenShift</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link href="../../../../css/tabzilla.css" rel="stylesheet">
    <link href="../../../../css/styles.css" rel="stylesheet">
    <link href="../../../../css/prettify.css" rel="stylesheet">
    <link href="../../../../css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../../../js/moment.min.js"></script>
    <script src="../../../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">
    <div id="wrap">
      <div class="dropup">
        <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
        <script>
            window.addEventListener('load', function() {
                 renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
        </script>
      </div>
	
    	<!-- Fixed navbar -->
        <nav class="navbar navbar-fixed-top" role="navigation">
          <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button class="navbar-toggle collapsed" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../../../../">Home</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav">
                <li><a href="../../../../overview/">Overview</a></li>
                <li><a href="../../../../blog.html">Blog</a></li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Services<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li class="menu-item dropdown dropdown-submenu">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../../hawkular-services/docs/quickstart-guide/">Quickstart</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../hawkular-services/docs/installation-guide/">Installation Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../hawkular-services/docs/user-guide/">User Guide</a>
                        </li>
                        <li class="menu-item dropdown dropdown-submenu">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">REST API</a>
                          <ul class="dropdown-menu">
                            <li class="menu-item ">
                              <a href="../../../../docs/rest/rest-alerts.html">Alerting</a>
                            </li>
                            <li class="menu-item ">
                              <a href="../../../../docs/rest/rest-inventory.html">Inventory</a>
                            </li>
                            <li class="menu-item ">
                              <a href="../../../../docs/rest/rest-metrics.html">Metrics</a>
                            </li>
                          </ul>
                        </li>
                      </ul>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-services/releases">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular APM<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                      <li><a href="../../../../hawkular-apm/">Overview</a></li>
                    </li>
                    <li>
                      <a href="https://hawkular.gitbooks.io/hawkular-apm-user-guide/content/">Documentation</a>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-apm/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Metrics<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../../hawkular-metrics/docs/user-guide/">Metrics User Guide</a>
                        </li>
                        <li class="menu-item ">
                            <a href="../../../../community/docs/developer-guide/alerts-v1.html">Alerting User Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../docs/rest/rest-metrics.html">Metrics REST API</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../docs/rest/rest-alerts-v1.html">Alerting REST API</a>
                        </li>
                      </ul>
                  </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-metrics/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Alerting<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item dropdown dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Alerting User Guide</a>
                            <ul class="dropdown-menu">
                              <li class="menu-item ">
                                <a href="../../../../community/docs/developer-guide/alerts-v1.html">Version 1</a>
                              </li>
                              <li class="menu-item ">
                                <a href="../../../../community/docs/developer-guide/alerts-v2.html">Version 2</a>
                              </li>
                            </ul>
                        </li>
                        <li class="menu-item dropdown dropdown-submenu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Alerting REST API</a>
                            <ul class="dropdown-menu">
                              <li class="menu-item ">
                                <a href="../../../../docs/rest/rest-alerts-v1.html">Version 1</a>
                              </li>
                              <li class="menu-item ">
                                <a href="../../../../docs/rest/rest-alerts-v2.html">Version 2</a>
                              </li>
                            </ul>
                        </li>
                      </ul>
                  </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-alerts/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li><a href="../../../../hawkular-clients/">Hawkular Clients</a></li>
                <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                  Community
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu">
                  <li>
                    <a href="../../../../community/docs/getting-involved/">Getting Involved</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../../../community/docs/developer-guide/">Developer Guide</a>
                  </li>
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="../../../../community/labs/datamining/">Datamining</a>
                        </li>
                        <li class="menu-item ">
                          <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                        </li>
                        <li class="menu-item ">
                          <a href="../../../../hawkular-clients/android-client/">Android client</a>
                        </li>
                        <li class="menu-item ">
                          <a href="https://github.com/jotak/hawkular-java-toolbox">Client-side java toolbox</a>
                        </li>
                      </ul>
                  </li>
                  <li>
                    <a href="https://github.com/hawkular">GitHub Repositories</a>
                  <li>
                    <a href="https://travis-ci.org/hawkular">CI Builds</a>
                  </li>
                </ul></li>
              </ul>
            </div>
          </div>
        </nav>

    <section class="main-banner blog-mainbanner">
        <div class="container">
            <h1>Adjusting sampling rates for Hawkular APM on OpenShift</h1>
            <p>A blog post by Juraci Paixão Kröhling</p>
<!-- show tags for this page -->
   <p> 
      <a href="/tags/apm.html">apm</a> 
          |
      <a href="/tags/obsidian-toaster.html">obsidian-toaster</a> 
          |
      <a href="/tags/openshift.html">openshift</a> 
          |
      <a href="/tags/opentracing.html">opentracing</a> 
          |
      <a href="/tags/vertx.html">vertx</a> 
  </p>
        </div>
    </section>

    <div class="blog-container">
        <br/><br/>
    	<p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>When doing distributed tracing of a busy application, it&#8217;s a good practice
to limit the amount of data being collected or stored. The techniques for that
are diverse, ranging from a simple "percentage based sampling" of the
incoming requests, up to complex heuristics to keep/discard traces based on the
code path.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-03-22-teaser.png" alt="Final result">
</div>
</div>
<div class="paragraph">
<p>It&#8217;s also a good practice to empower the admin, or an automated monitoring system,
with the capability of adjusting the sampling based on the current conditions.
For instance, we&#8217;d probably want to get more traces from a
<a href="/blog/2017/02/13/monitoring-canary-deployments.html">newly deployed version</a>
of an existing application, as we might want to compare the performance and adjust
the percentage in steps. Or even, we want more information from an application
that we suspect to be behaving badly. Similarly, if we are experiencing
expected traffic peaks and need every resource available, we might enable tracing
only to a small percentage of the incoming requests.</p>
</div>
<div class="paragraph">
<p>For the simple scenario, let&#8217;s call it "percentage based sampling", we have a few
alternatives on how to implement it:</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_application_based_decision">Application-based decision</h3>
<div class="paragraph">
<p>In this scenario, we embed the logic into the application, using the percentage
as the probability a random number is within a range. In other words: 20% sampling
would be 20% chance that a number is lower or equal to 2 on a range of 1-10.
Anything more complex than that would be "too much" for our scenario.</p>
</div>
<div class="paragraph">
<p>As hinted before, we want to externalize the percentage so that an external
actor can change this. One solution is to store this percentage number into an
environment variable on the Deployment Configuration (DC). This will, however,
rollout a new deployment after every change, which might not be desirable in some
scenarios.</p>
</div>
<div class="paragraph">
<p>Another solution is to externalize this into a Configuration Map (ConfigMap),
but then, we also need to let our application listen to events related to this
ConfigMap. For a microservice, we might end up with a bunch of unrelated
dependencies, just to decide whether or not to trace a request.</p>
</div>
</div>
<div class="sect2">
<h3 id="_openshift_based_decision">OpenShift-based decision</h3>
<div class="paragraph">
<p>In this scenario, we delegate the decision to our runtime environment. Similar
to a simple A/B testing scenario, our deployment architecture would allow for
quick changes in the routing decision. It does require a simple change to our
application, but it&#8217;s a small compromise for the benefits it provides.</p>
</div>
<div class="paragraph">
<p>For that, we&#8217;ll use one single Image Stream (<code>is</code>) with our code, two Deployment
Configurations (<code>dc</code>), two Services (<code>svc</code>) and one Route object. Each one of our
<code>dc</code> objects would have a different value for an environment variable called
<code>TRACER_ENABLED</code>. Each <code>svc</code> has its own <code>dc</code>, and the router sends a
percentage of the requests to each of the <code>svc</code> instances. The main advantage of
this approach is that the application image is the same for both <code>tracing-enabled</code>
and <code>tracing-disabled</code> scenarios.</p>
</div>
</div>
<h1 id="_doing_it" class="sect0">Doing it!</h1>
<div class="paragraph">
<p>Enough talk, let&#8217;s start doing it. The first step is to create an OpenShift
cluster. The following commands will give us a recent version of OpenShift Origin
and will deploy Hawkular APM on it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc cluster up --version=latest
$ oc create -f https://raw.githubusercontent.com/jboss-dockerfiles/hawkular-apm/master/openshift-templates/hawkular-apm-server-deployment.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll now bootstrap a vert.x application from scratch via
<a href="http://start.prod-preview.openshift.io/">Obsidian Toaster</a>. For our example,
click on "&#8230;&#8203; selecting a runtime project framework", select "Vert.x" and give
it a name like <code>conditional-tracer</code> (leave the package name as <code>com.example</code>
and the version as <code>1.0.0-SNAPSHOT</code>). On the next step, set the Vert.x version
to <code>3.3.3</code> and select <code>Vert.x Web</code>. Scroll down the list and click <code>Finish</code> and
download the ZIP file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Obsidian Toaster is still in alpha. If it&#8217;s not working for some reason,
we have a ZIP file ready for you to download link:
<a href="/data/blog/2017/2017-03-22-conditional-tracer.zip">conditional-tracer.zip</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s add our Hawkular APM dependencies to our new project by adding the following
lines to the <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.hawkular.apm&lt;/groupId&gt;
  &lt;artifactId&gt;hawkular-apm-trace-publisher-rest-client&lt;/artifactId&gt;
  &lt;version&gt;0.14.2.Final&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.hawkular.apm&lt;/groupId&gt;
  &lt;artifactId&gt;hawkular-apm-client-opentracing&lt;/artifactId&gt;
  &lt;version&gt;0.14.2.Final&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
  &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;
  &lt;version&gt;2.6.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
  &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;
  &lt;version&gt;2.6.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
  &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
  &lt;version&gt;2.6.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
we need to override the Jackson dependencies because of incompatibilities
between the version Hawkular APM uses and the one Vert.x uses.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We now remove the <code>src/main/fabric8/svc.yml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ rm src/main/fabric8/svc.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll create two service files instead:</p>
</div>
<div class="paragraph">
<p><code>src/main/fabric8/no-tracer-svc.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: conditional-tracer-disabled
  labels:
    tracer: disabled
spec:
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    group: com.example
    project: conditional-tracer
    tracer: disabled
  type: ClusterIP</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>src/main/fabric8/tracer-svc.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: conditional-tracer-enabled
  labels:
    tracer: enabled
spec:
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    group: com.example
    project: conditional-tracer
    tracer: enabled
  type: ClusterIP</code></pre>
</div>
</div>
<div class="paragraph">
<p>We now create our two <code>dc</code> objects:</p>
</div>
<div class="paragraph">
<p><code>src/main/fabric8/no-tracer-dc.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: DeploymentConfig
metadata:
  labels:
    group: com.example
    project: conditional-tracer
    tracer: disabled
  name: conditional-tracer-disabled
spec:
  replicas: 1
  selector:
    group: com.example
    project: conditional-tracer
    tracer: disabled
  template:
    metadata:
      labels:
        group: com.example
        project: conditional-tracer
        tracer: disabled
    spec:
      containers:
      - env:
        - name: HAWKULAR_APM_URI
          value: http://hawkular-apm
        - name: HAWKULAR_APM_USERNAME
          value: admin
        - name: HAWKULAR_APM_PASSWORD
          value: password
        - name: TRACER_ENABLED
          value: false
        - name: JAVA_APP_DIR
          value: /deployments
        - name: JAVA_MAIN_CLASS
          value: io.vertx.core.Launcher
        name: java-exec
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
      dnsPolicy: ClusterFirst
  triggers:
  - type: ConfigChange
  - imageChangeParams:
      automatic: true
      containerNames:
      - java-exec
      from:
        kind: ImageStreamTag
        name: conditional-tracer:latest
    type: ImageChange</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>src/main/fabric8/tracer-dc.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: DeploymentConfig
metadata:
  labels:
    group: com.example
    project: conditional-tracer
    tracer: enabled
  name: conditional-tracer-enabled
spec:
  replicas: 1
  selector:
    group: com.example
    project: conditional-tracer
    tracer: enabled
  template:
    metadata:
      labels:
        group: com.example
        project: conditional-tracer
        tracer: enabled
    spec:
      containers:
      - env:
        - name: HAWKULAR_APM_URI
          value: http://hawkular-apm
        - name: HAWKULAR_APM_USERNAME
          value: admin
        - name: HAWKULAR_APM_PASSWORD
          value: password
        - name: TRACER_ENABLED
          value: true
        - name: JAVA_APP_DIR
          value: /deployments
        - name: JAVA_MAIN_CLASS
          value: io.vertx.core.Launcher
        name: java-exec
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
      dnsPolicy: ClusterFirst
  triggers:
  - type: ConfigChange
  - imageChangeParams:
      automatic: true
      containerNames:
      - java-exec
      from:
        kind: ImageStreamTag
        name: conditional-tracer:latest
    type: ImageChange</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally, we change our <code>route.yml</code> to alternate the requests among the
services:</p>
</div>
<div class="paragraph">
<p><code>src/main/fabric8/route.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>apiVersion: v1
kind: Route
metadata:
  name: conditional-tracer
spec:
  alternateBackends:
  - kind: Service
    name: conditional-tracer-disabled
    weight: 80
  to:
    kind: Service
    name: conditional-tracer-enabled
    weight: 20</code></pre>
</div>
</div>
<div class="paragraph">
<p>The only remaining change is within our Java code, to use a <code>NoopTracer</code> by
default, using a concrete tracer (<code>APMTracer</code>) if the environment variable
<code>TRACER_ENABLED</code> parses to <code>true</code>:</p>
</div>
<div class="paragraph">
<p><code>src/main/java/com/example/MainVerticle.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class MainVerticle extends AbstractVerticle {
    private Tracer tracer = NoopTracerFactory.create();

    @Override
    public void start() {
        boolean tracerEnabled = Boolean.parseBoolean(System.getenv("TRACER_ENABLED"));
        if (tracerEnabled) {
            tracer = new APMTracer();
        }
        vertx.createHttpServer()
                .requestHandler((req) -&gt; {
                    Span span = tracer.buildSpan("hello-world-request").start();
                    span.setTag("enabled", tracerEnabled);
                    req.response().end(String.format("Hello World! Are we tracing this request? %s", System.getenv("TRACER_ENABLED")));
                    span.finish();
                })
                .listen(8080);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, we are ready to test it! As we already have an OpenShift cluster
running with our Hawkular APM server, we just need to run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ mvn clean fabric8:deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the build finishes running, we should see the following on OpenShift&#8217;s Web
Console:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-03-22-final-result.png" alt="Final result">
</div>
</div>
<div class="paragraph">
<p>To check whether our tracing is working, we can use a script like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ export URL="http://conditional-tracer-myproject.192.168.2.107.xip.io"
$ for i in `seq 1 10` ; do curl ${URL} 2&gt;/dev/null | awk '{print $NF}' ; done | sort | uniq -c</code></pre>
</div>
</div>
<div class="paragraph">
<p>An output similar to this one should be printed out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>8 false
2 true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that 8 didn&#8217;t have their traces published and two requests had
their traces published to Hawkular APM. You can check that by logging into Hawkular
APM (username: <code>admin</code>, password: <code>password</code>) and looking into the
<code>Distributed Tracing</code> screen. There should be only two traces there.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You might be tempted to try opening the URL in your browser and hitting
refresh, but you&#8217;ll notice that the OpenShift router tries to send you to the same
backend service all the time. For this reason, it makes more sense to test on
the command line with <code>curl</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>From this point and on, we can adjust the percentage by changing the route. One
way to do that is by issuing the command <code>oc edit route conditional-tracer</code>,
or by navigating on the UI to <code>Applications - Routes - conditional-tracer -
Actions - Edit</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-03-22-edit-route.png" alt="Final result">
</div>
</div>
<div class="sect1">
<h2 id="_wrapping_up">Wrapping up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Deciding whether a transaction should be traced or not is a decision that should
be outsourced as much as possible to the underlying Tracer, possibly with data
coming from different sources. Having a simple switch on the code loading the
Tracer, however, might prove invaluable to admins in determined situations.
Given the simplicity of this solution, there&#8217;s no reason not to have it!</p>
</div>
<div class="paragraph">
<p>The full source code for this example can be found at
<a href="https://github.com/jpkrohling/conditional-tracer">github.com/jpkrohling/conditional-tracer</a>.</p>
</div>
</div>
</div></p>
    	<hr /><br /><br />

        <p><em>Published by Juraci Paixão Kröhling on  22 March 2017</em></p>

    <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'hawkular';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../../../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../../../js/jbossorg-tabzilla.js"></script>
    <script src="../../../../js/behavior.js"></script>
    <script src="../../../../js/prettify.js"></script>
    <script src="../../../../js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
